/**
 * @license
 * 
 * shelly-porssisahko
 * shelly-porssisahko-en
 * 
 * (c) Jussi isotalo - http://jisotalo.fi
 * https://github.com/jisotalo/shelly-porssisahko
 * https://github.com/jisotalo/shelly-porssisahko-en
 * 
 * License: GNU Affero General Public License v3.0 
 */
const CNST={INST_COUNT:"undefined"==typeof INSTANCE_COUNT?3:INSTANCE_COUNT,HIST_LEN:"undefined"==typeof HIST_LEN?24:HIST_LEN,ERR_LIMIT:3,ERR_DELAY:120,DEF_INST_ST:{chkTs:0,st:0,str:"",cmd:-1,configOK:0,fCmdTs:0,fCmd:0},DEF_CFG:{COM:{g:"fi",vat:25.5,day:0,night:0,q:0,names:[]},INST:{en:0,mode:0,m0:{c:0},m1:{l:0},m2:{p:24,c:0,l:-999,s:0,m:999,ps:0,pe:23,ps2:0,pe2:23,c2:0},b:0,e:0,o:[0],f:0,fc:0,i:0,m:60,oc:0}}};let _={s:{v:"3.4.0-a.1",dn:"",configOK:0,timeOK:0,errCnt:0,errTs:0,upTs:0,tz:"+02:00",tzh:0,enCnt:0,p:[{ts:0,now:0,low:0,high:0,avg:0},{ts:0,now:0,low:0,high:0,avg:0}]},si:[CNST.DEF_INST_ST],p:[[],[]],h:[],c:{c:CNST.DEF_CFG.COM,i:[CNST.DEF_CFG.INST]}},_i=0,_j=0,_k=0,_inc=0,_cnt=0,_start=0,_end=0,cmd=[],prevEpoch=0,loopRunning=!1;function getKvsKey(e){let t="porssi";return t=0<=e?t+"-"+(e+1):t}function calculateAverage(t){let n=0;if(0!==t.length){for(let e=0;e<t.length;e++)n+=t[e];n/=t.length}return n}function limit(e,t,n){return Math.min(n,Math.max(e,t))}function epoch(e){return Math.floor((e?e.getTime():Date.now())/1e3)}function getDate(e){return e.getDate()}function updateTz(e){let t=e.toString(),n=0;"+0000"==(t=t.substring(3+t.indexOf("GMT")))?(t="Z",n=0):(n=+t.substring(0,3),t=t.substring(0,3)+":"+t.substring(3)),t!=_.s.tz&&(_.s.p[0].ts=0),_.s.tz=t,_.s.tzh=n}function log(e){console.log("shelly-porssisahko: "+e)}function reqLogic(){for(let e=0;e<CNST.INST_COUNT;e++)_.si[e].chkTs=0}function updateState(){var e=new Date,t=(_.s.timeOK=null!=Shelly.getComponentStatus("sys").unixtime&&2e3<e.getFullYear(),_.s.dn=Shelly.getComponentConfig("sys").device.name,epoch(e));for(_.s.timeOK&&300<Math.abs(t-prevEpoch)&&(log("Time changed 5 min+ -> refresh"),_.s.p[0].ts=0,_.s.p[0].now=0,_.s.p[1].ts=0,_.p[0]=[],_.p[1]=[]),prevEpoch=t,_.s.enCnt=0,_i=0;_i<CNST.INST_COUNT;_i++)_.c.i[_i].en&&_.s.enCnt++;!_.s.upTs&&_.s.timeOK&&(_.s.upTs=epoch(e))}function getConfig(l){var e=getKvsKey(l);Shelly.call("KVS.Get",{key:e},function(t,e,n){l<0?_.c.c=t?JSON.parse(t.value):{}:_.c.i[l]=t?JSON.parse(t.value):{},"function"==typeof USER_CONFIG&&USER_CONFIG(l,!0);{t=l;var r=function(e){l<0?_.s.configOK=e?1:0:(log("config for #"+(l+1)+" read, enabled: "+_.c.i[l].en),_.si[l].configOK=e?1:0,_.si[l].chkTs=0),loopRunning=!1,Timer.set(500,!1,loop)};let e=0;if(CNST.DEF_CFG.COM||CNST.DEF_CFG.INST){var s,i=t<0?CNST.DEF_CFG.COM:CNST.DEF_CFG.INST,o=t<0?_.c.c:_.c.i[t];for(s in i)if(void 0===o[s])o[s]=i[s],e++;else if("object"==typeof i[s])for(var c in i[s])void 0===o[s][c]&&(o[s][c]=i[s][c],e++);t>=CNST.INST_COUNT-1&&(CNST.DEF_CFG.COM=null,CNST.DEF_CFG.INST=null),0<e?(t=getKvsKey(t),Shelly.call("KVS.Set",{key:t,value:JSON.stringify(o)},function(e,t,n,r){t&&log("failed to set config: "+t+" - "+n),r(0==t)},r)):r(!0)}else r(!0)}})}function loop(){try{if(!loopRunning)if(loopRunning=!0,updateState(),_.s.configOK)if(pricesNeeded(0))getPrices(0);else if(pricesNeeded(1))getPrices(1);else{for(let e=0;e<CNST.INST_COUNT;e++)if(!_.si[e].configOK)return void getConfig(e);for(let e=0;e<CNST.INST_COUNT;e++)if(function(e){var t=_.si[e],n=_.c.i[e];if(1!=n.en)return void(_.h[e]=[]);var e=new Date,r=new Date(1e3*t.chkTs);return 0==t.chkTs||r.getHours()!=e.getHours()||_.c.c.q&&Math.floor(r.getMinutes()/15)!=Math.floor(e.getMinutes()/15)||r.getFullYear()!=e.getFullYear()||0<t.fCmdTs&&t.fCmdTs-epoch(e)<0||0==t.fCmdTs&&n.m<60&&e.getMinutes()>=n.m&&t.cmd+n.i==1}(e))return void Timer.set(500,!1,logic,e);"function"==typeof USER_LOOP?USER_LOOP():loopRunning=!1}else getConfig(-1)}catch(e){log("error at main loop:"+e),loopRunning=!1}}function pricesNeeded(e){var t=new Date;let n=!1;return n=1==e?_.s.timeOK&&0===_.s.p[1].ts&&15<=t.getHours():((e=getDate(new Date(1e3*_.s.p[0].ts))!==getDate(t))&&(_.s.p[1].ts=0,_.p[1]=[]),_.s.timeOK&&(0==_.s.p[0].ts||e)),_.s.errCnt>=CNST.ERR_LIMIT&&epoch(t)-_.s.errTs<CNST.ERR_DELAY?n=!1:_.s.errCnt>=CNST.ERR_LIMIT&&(_.s.errCnt=0),n}function getPrices(f){try{log("fetching prices for day "+f);let d=new Date;updateTz(d);var t=1==f?new Date(864e5+new Date(d.getFullYear(),d.getMonth(),d.getDate()).getTime()):d;let e=t.getFullYear()+"-"+(t.getMonth()<9?"0"+(1+t.getMonth()):1+t.getMonth())+"-"+(getDate(t)<10?"0"+getDate(t):getDate(t))+"T00:00:00"+_.s.tz.replace("+","%2b");let g={T00:"T12",T11:"T23"};var n=e.replace("T00:00:00","T11:59:59");let m={url:"https://dashboard.elering.ee/api/nps/price/csv?fields="+_.c.c.g+"&start="+e+"&end="+n,timeout:5,ssl_ca:"*"};d=null,e=null,_.p[f]=[],_.s.p[f].avg=0,_.s.p[f].high=-999,_.s.p[f].low=999,Shelly.call("HTTP.GET",m,function s(i,e,o,c){try{if(0!==e||null==i||200!==i.code||!i.body_b64)throw Error(e+"("+o+") - "+JSON.stringify(i));{i.headers=null,o=i.message=null,i.body_b64=atob(i.body_b64),i.body_b64=i.body_b64.substring(1+i.body_b64.indexOf("\n"));let e=0,t=0,n=-1,r=[-1,[]];function l(){var e=calculateAverage(r[1]);_.c.c.q&&1!=f||(r[1]=[e]),_.p[f].push(r),_.s.p[f].avg+=e,e>_.s.p[f].high&&(_.s.p[f].high=e),e<_.s.p[f].low&&(_.s.p[f].low=e)}for(;0<=e;){i.body_b64=i.body_b64.substring(e);var p=[e=0,0];if(0==(e=1+i.body_b64.indexOf('"',e))){0<t&&l();break}p[0]=+i.body_b64.substring(e,i.body_b64.indexOf('"',e)),e=2+i.body_b64.indexOf('"',e),e=2+i.body_b64.indexOf(';"',e),p[1]=+(""+i.body_b64.substring(e,i.body_b64.indexOf('"',e)).replace(",",".")),p[1]=p[1]/10*(100+(0<p[1]?_.c.c.vat:0))/100;var a=new Date(1e3*p[0]).getHours();p[1]+=7<=a&&a<22?_.c.c.day:_.c.c.night,e=i.body_b64.indexOf("\n",e),n<0&&(r[0]=p[0],n=a),(n!=a||e<0)&&(l(),r=[p[0],[]],t=0,n=a),r[1].push(p[1]),t++}if(i=null,0<--c){for(var u in g)g.hasOwnProperty(u)&&(m.url=m.url.replace(u,g[u]));return void Shelly.call("HTTP.GET",m,s,c)}if(m=null,_.s.p[f].avg=0<_.p[f].length?_.s.p[f].avg/_.p[f].length:0,_.s.p[f].ts=epoch(d),_.p[f].length<23)throw Error("invalid data received")}}catch(e){log("error getting prices: "+e),_.s.errCnt+=1,_.s.errTs=epoch(),_.s.p[f].ts=0,_.p[f]=[]}0==f&&reqLogic(),loopRunning=!1,Timer.set(500,!1,loop)},2)}catch(e){log("error getting prices: "+e),_.s.errCnt+=1,_.s.errTs=epoch(),_.s.p[f].ts=0,_.p[f]=[],0==f&&reqLogic(),loopRunning=!1,Timer.set(500,!1,loop)}}function logic(i){try{"function"==typeof USER_CONFIG&&USER_CONFIG(i,!1),cmd[i]=!1;var e,t,n=new Date;updateTz(n),!function(){if(_.s.timeOK&&0!=_.s.p[0].ts){var t=new Date,n=epoch(t);for(let e=0;e<_.p[0].length;e++)if(function(e,t){return 0<=(t-=e)&&t<3600}(_.p[0][e][0],n))return _.c.c.q?_.s.p[0].now=_.p[0][e][1][Math.floor(t.getMinutes()/15)]:_.s.p[0].now=calculateAverage(_.p[0][e][1]);_.s.timeOK=!1,_.s.p[0].ts=0,_.s.errCnt+=1,_.s.errTs=epoch()}else _.s.p[0].ts,_.s.p[0].now=0}();let r=_.si[i],s=_.c.i[i];function o(e){if(null==e)loopRunning=!1;else if(cmd[i]!=e&&(r.st=12),cmd[i]=e,s.i&&(cmd[i]=!cmd[i]),log("logic for #"+(i+1)+" done, cmd: "+e+" -> output: "+cmd[i]),1==s.oc&&r.cmd==cmd[i])log("outputs already set for #"+(i+1)),r.cmd=cmd[i]?1:0,r.chkTs=epoch(),loopRunning=!1;else{let t=0,n=0;for(let e=0;e<s.o.length;e++)!function(e,s,i){e="{id:"+s+",on:"+(cmd[e]?"true":"false")+"}",Shelly.call("Switch.Set",e,function(e,t,n,r){0!=t&&log("setting output "+s+" failed: "+t+" - "+n),i(0==t)},i)}(i,s.o[e],function(e){t++,e&&n++,t==s.o.length&&(n==t&&(r.cmd,cmd[i],r.cmd=cmd[i]?1:0,r.chkTs=epoch(),Timer.set(500,!1,loop)),loopRunning=!1)})}}0===s.mode?(cmd[i]=1===s.m0.c,r.st=1):_.s.timeOK&&0<_.s.p[0].ts&&getDate(new Date(1e3*_.s.p[0].ts))===getDate(n)?1===s.mode?(cmd[i]=_.s.p[0].now<=("avg"==s.m1.l?_.s.p[0].avg:s.m1.l),r.st=cmd[i]?2:3):2===s.mode&&(cmd[i]=function(e){var t=_.c.i[e],e=_.c.c;for(t.m2.ps=limit(0,t.m2.ps,23),t.m2.pe=limit(t.m2.ps,t.m2.pe,24),t.m2.ps2=limit(0,t.m2.ps2,23),t.m2.pe2=limit(t.m2.ps2,t.m2.pe2,24),t.m2.c=limit(0,t.m2.c,0<t.m2.p?t.m2.p:t.m2.pe-t.m2.ps),t.m2.c2=limit(0,t.m2.c2,t.m2.pe2-t.m2.ps2),_cntMultiplier=e.q?4:1,_cheapest={},_inc=t.m2.p<0?1:t.m2.p,_i=0;_i<_.p[0].length;_i+=_inc)if(!((_cnt=-2==t.m2.p&&1<=_i?t.m2.c2:t.m2.c)<=0)){for(_order={},_start=_i,_end=_i+t.m2.p,t.m2.p<0&&0==_i?(_start=t.m2.ps,_end=t.m2.pe):-2==t.m2.p&&1==_i&&(_start=t.m2.ps2,_end=t.m2.pe2),_j=_start;_j<_end&&!(_j>_.p[0].length-1);_j++)_order[_j]=_.p[0][_j][1],_cheapest[_j]={};if(t.m2.s){for(_hours=Object.keys(_order),_sum=0,_quarterCounter=0,_avg=999,_startIndex=null,_skipCounter=-1,_j=0;_j<=_hours.length;_j++)for(_k=0;_k<_order[_hours[_j]].length;_k++)_sum+=_order[_hours[_j]][_k],++_quarterCounter>=_cnt*_cntMultiplier&&(_sum/(_cnt*_cntMultiplier)<_avg&&(_avg=_sum/(_cnt*_cntMultiplier),_startIndex=_skipCounter+1),_skipCounter++,sum-=_order[_hours[Math.floor(_skipCounter/_cntMultiplier)]][_skipCounter%_cntMultiplier]);if(null!=_startIndex)for(_temp=null,_quarter=0,_quarterCounter=0,_j=0;_j<_cnt*_cntMultiplier;_j++)_temp!=_hours[Math.floor((_j+_startIndex)/_cntMultiplier)]&&(_quarterCounter=0),_temp=_hours[Math.floor((_j+_startIndex)/_cntMultiplier)],_quarter=(_j+_startIndex)%_cntMultiplier,_quarterCounter++,t.m<60&&4==_cntMultiplier&&15*_quarterCounter>t.m||(_cheapest[_temp][_quarter]=!0);_order={}}else{for(_j in _entries=[],_order)if(_order.hasOwnProperty(_j))for(_quarter=0;_quarter<_order[_j].length;_quarter++)_entries.push([_order[_j][_quarter],_j,_quarter]);for(_order={},_j=0,_k=1;_k<_entries.length;_k++){for(_temp=_entries[_k],_j=_k-1;0<=_j&&_temp[0]<_entries[_j][0];_j--)_entries[_j+1]=_entries[_j];_entries[_j+1]=_temp}for(_cheapestCounter=0,_j=0;_j<_entries.length&&(_entry=_entries[_j],t.m<60&&4==_cntMultiplier&&15*Object.keys(_cheapest[_entry[1]]).length>=t.m||(_cheapest[_entry[1]][_entry[2]]=!0,!(++_cheapestCounter>=_cnt*_cntMultiplier)));_j++);}if(_entries=[],-1==t.m2.p||-2==t.m2.p&&1<=_i)break}e=new Date,e=(_cheapest[e.getHours()]||{})[Math.floor(e.getMinutes()/15)]||!1;return _cheapest={},e}(i),r.st=cmd[i]?5:4,!cmd[i]&&_.s.p[0].now<=("avg"==s.m2.l?_.s.p[0].avg:s.m2.l)&&(cmd[i]=!0,r.st=6),cmd[i])&&_.s.p[0].now>("avg"==s.m2.m?_.s.p[0].avg:s.m2.m)&&(cmd[i]=!1,r.st=11):_.s.timeOK?(r.st=7,e=1<<n.getHours(),(s.b&e)==e&&(cmd[i]=!0)):(cmd[i]=1===s.e,r.st=8),_.s.timeOK&&0<s.f&&(t=1<<n.getHours(),(s.f&t)==t)&&(cmd[i]=(s.fc&t)==t,r.st=10),cmd[i]&&_.s.timeOK&&n.getMinutes()>=s.m&&(!_.c.c.q||2!==s.mode)&&(r.st=13,cmd[i]=!1),_.s.timeOK&&0<r.fCmdTs&&(0<r.fCmdTs-epoch(n)?(cmd[i]=1==r.fCmd,r.st=9):r.fCmdTs=0),"function"==typeof USER_OVERRIDE?USER_OVERRIDE(i,cmd[i],o):o(cmd[i])}catch(e){log("error running logic: "+JSON.stringify(e)),loopRunning=!1}}let _cntMultiplier=1,_cheapest={},_order={},_hours=[],_sum=0,_quarterCounter=0,_avg=999,_startIndex=0,_skipCounter=-1,_temp=null,_quarter=0,_entries=[],_cheapestCounter=0,_entry={};log("v."+_.s.v),log("URL: http://"+(Shelly.getComponentStatus("wifi").sta_ip??"192.168.33.1")+"/script/"+Shelly.getCurrentScriptId()),_.c.i.pop(),_.si.pop();for(let e=0;e<CNST.INST_COUNT;e++)_.si.push(Object.assign({},CNST.DEF_INST_ST)),_.c.i.push(Object.assign({},CNST.DEF_CFG.INST)),_.c.c.names.push("-"),_.h.push([]),cmd.push(!1);CNST.DEF_INST_ST=null,prevEpoch=epoch(),HTTPServer.registerEndpoint("",function(n,r){try{if(loopRunning)return n=null,r.code=503,void r.send();var s=function(e){var t={},n=e.split("&");for(let e=0;e<n.length;e++){var r=n[e].split("=");t[r[0]]=r[1]}return t}(n.query),i=parseInt(s.i);n=null;let e="application/json",t=(r.code=200,!0);var o="text/html",c="text/javascript";if("s"===s.r)updateState(),0<=i&&i<CNST.INST_COUNT&&(r.body=JSON.stringify({s:_.s,si:_.si[i],c:_.c.c,ci:_.c.i[i],p:_.p})),t=!1;else if("c"===s.r)updateState(),0<=i&&i<CNST.INST_COUNT?r.body=JSON.stringify(_.c.i[i]):r.body=JSON.stringify(_.c.c),t=!1;else if("h"===s.r)0<=i&&i<CNST.INST_COUNT&&(r.body=JSON.stringify(_.h[i])),t=!1;else if("r"===s.r){if(0<=i&&i<CNST.INST_COUNT)log("config changed for #"+(i+1)),_.si[i].configOK=!1;else{log("config changed");for(let e=0;e<CNST.INST_COUNT;e++)_.si[e].configOK=!1}_.s.configOK=!1,reqLogic(),loopRunning||(loopRunning=!0,getConfig(i)),_.s.p[0].ts=0,_.s.p[1].ts=0,r.code=204,t=!1}else"f"===s.r&&s.ts?(0<=i&&i<CNST.INST_COUNT&&(_.si[i].fCmdTs=+(""+s.ts),_.si[i].fCmd=+(""+s.c),_.si[i].chkTs=0),r.code=204,t=!1):s.r?"s.js"===s.r?(r.body=atob("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"),e=c):"s.css"===s.r?(r.body=atob("H4sIAAAAAAAACo1WTW/jNhD9K4MNFsh6LVmK16lDoUF7WqBoi17aS9EDRY0s1hRJkONEXsP/vSD1YcVJsL0YJjnD+XjzHrVaLGABvkGljok1znvpebM3ELZvxSf45eC9BOkNcWUggYbIstXq32EnrSUs4qZnq9VOUnMoU2HayWD1zt2/SoHaI4Ovv/8JP9c1OgNfUaPjCv44lEqK0QSe1mkGixUs4ASl6RIvv0m9Y1AaV6FLStMVcIbSVMclcDiBMMo4Bjco6qzOx7PgzMV+58xBVwxu7sQaN1kBSmpMGpS7hhjk6RdsC6iNphAGGWTpw7RT81aqI4O/0FVc8wJa3iXPsqKGwZcHF+yGVZ5lH8Ox20nNIAN+IFOA5VUVM9/YDvLMxrxvSJJCOM2DDmn0/klpiEwbvaKDMPb40j5Lt8GeK7nTiUdVM6gVdgnqqgDCjpJ4xMCFMsMlaa06OEElvVX82JvHfeKlhxNY4yVJE1xQcZJPWLxsX85L8SAmF8ZKrI3D5bjkNaGLYGhCTQw+fCgu4YiXCmfOk7VC7gKy1IynoVJlODFQWPe5k19C2szT10ZP1yWKl6jmp6UyYn+F9F36wyb0bMIkgzy9CzvDWLnBznbgjZIV3OT3PNtuChAH58OAWSM1oZviDqXC6eUUXFrJS2/UgbCAb4nUFXYM8gLI2Es6oUYG2SyvPM7Vi97XdV1MUz7OsbFcSDpG59gjJhoUe6w+v2jK9y/q63/jnnjF56tSp7D5rKq73tXYOQo7J6si/iaErVWcMBFGHVrtGeS1iyQJf6Kzt3rWyPQuduFC0349pRrXA07kuPaWO9Q0gTnWOE7tsE3GjkfPjQzAjODzSh48g00AkGvZ8h7BkFXu4yRxB1LXUke3qUip45QNE3eGn/Z4rB1v0UNfUZgJOPVJ1sa1DJwhTni7vs8q3H2CM5x7eqRCPFJQrkdyj1SxWjpPiWikqpaQlrvlYOZbIDc/HbXheehWaVRVwBM6koKrUQrI2PcpXasuaU3AWUX+YZdU0qEYJME8x9parCS/nYvgNrPdJzi9rVH3AbK5GvWEHlQu0iDZ2m42O98ZltHyEZimpi/+dh3irxbwG99LvQNqENaugt4ZdgbIgMaOIoiLVR+jP2WQwwqS+GT0vW3nCCzhptw/vqcuLzj/pv8VRkPdA+ND3ZepjOyb3rde/rPZta8Rn/vmtoNScbHvGfE/EO3rvzZ8rOTTlOiQwJDCJaIPAhAFdM42xW143Md/r9tzyfmNfOcPZQ+yCJyZjY7ASXprOZfcj0VP5ZgXhpfh2XEbDZ/zbTaz3I6Xt5RnFzz6Dg6Pc+hGPvQrSlwwd5t5U+Jjng1q2arNNbJjlHIJNz4R7Tv0PIPU9kB/09Hij+WByOh/rj8K8kCg84X2pzc+VIbqRnpcJCLEnfq6Dkm93U9/aFvuAnlfv3P/AXPmnH4uCgAA"),e="text/css"):"status"===s.r?(r.body=atob("H4sIAAAAAAAACpWSS26DMBRFt2IxaiMBYVCpA8cLqCp10GzgYTvC4A/FjyTshzV0A2ys4mclbfqbeOB773n3WaYIuZaEa/B+FxnCecQoNoyiYM+gUJISiCtKaD1FQZTY+VjY1bLkTtnjlr1MJmI7DEZuRogABLBJkqzcyVl5aYmXWqEMfo9h9uvQF9XwbkmhLMIV1boTu0J57Lq6VsFgnJDBsVcagqLswTGaTjszKtRxXfygz+Sgz7Fxecydjq5E5KOWEdM8fBEMZtuI0XwtTHDo7dAPvaVpzmgq1JHR+Y2nBrXa3ixwido7lC22Bn6AzTHkC/UCOrtu1dd/qF+0zkhr4bv22T/a/8LKPneeT9/WbLOpoapcvHy8dLyb5k3JY9g+ZHijamSNfHvydxFCHnsEbH1S+uiepov8ARap9CvsAgAA"),e=o):"status.js"===s.r?(r.body=atob("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"),e=c):"config"===s.r?(r.body=atob("H4sIAAAAAAAACpVWS27jRhC9SoNBMPaC+nCcGcOgGuDCA8uWpSCSHWRZIttmmd1Nml2Uo6xzFJ7BF+DFAv4kkbbszEYCu36vq94r0g1wwzCY+A+PtmS+BGMm5PMZBEAAejAYuMMAN9zd+zFDWykmAZpEwvZCx1rU5jraIp+trdrnIdZkG/xHXIwHjlD8r9nldHm5Yt7ycnV3s7xcNckJ1lK08Yr5vsVdSrlLAb8FKP9cI6TwqYTwyN04IYw124DMxOQB+TKLFXZPheD3mMbdQ7nhM6ANQu+Y+AwFUQbusK7Tlm8wvYzPR3xZ5GFUvGrmze4rSKiTrEK0AWLlLSdfOfu1Bb5ETClWEJmMyufRd9txLtg+KoDtLsofRn+GB01UNB5xx7FH3w8jND6G1ItpGljXvIeUCE0N9AAjbRMx8UPhR+v47zLTM3eHVdP7kysLHx3f4urau1uyX1yTgK7YgNwdlg/800EedvKmyLdUvBpT5BVICWshj2IVmrPFfLj48cMdNp7NdeeosDsJvbMtwifIDEHSp4+KA8H7c67ciaCcpCzyMCheqZs5zsjUrT/bBc1qT83iqlivUOz3iDriHmpgBGmEhkAY0+PhmN8DaqayjCirzO/BzIxCnWWEPYQK9Y4bCnUbclPkRa5JoBYdoEe6jbpDJ5VlhjKtq2KlfR3tzFdFTkVOKOEg7SezTNNjw/wdoii2q0yREfXdAkGA0rSikL9x12RKQbrl84pD+TBBlDGVnWoMDQcxmDyELRONqoht7Vk/bFK/q4NGBPym+Hc5rUn/U/xe/N92qJHtq+BNRz6AdDWdr7w/vGvvpwBdoSZI4Ql6jBnbElV/oRwvfu3dLBdzduXN7qe3t96Kre7m8+nnS/wQivcE+gkiE/dl6diJSHuKcc64cxb2ROLwsdM7O+fnvZNv/Fvv5Iz3M33lX3snDu9ntsc8VlA+lC1kJ2NWgT/teTldL6f2gtOdgFm9M+tGhBwwgk2RS2QnkYxPL9otSmnLdcf2a8UrYNDp2X58jp2YdnoXoxGzWdcoDoytzFaZJlTlTkib7XsY4uv9+yXsonHewmHOO4CcDxE5XUhv8nfgvZPf1+R0ENa7Q6RFHkVFju3mOCY4xzbPu5VTreOkLCZlkTO7p5C6TBMmUbUK2X2ZRAYVhuXIj0WpD1TVvG2tgwsa2Iga9Doj2tFrBVIKrYEffIu9eWXz1WJ6O53PF6s3XuS3NfZfF50y5bKMU1809Q5WseHuOv0kOta+RD+afHlBHcQvgzgR+sQaWqdf6nTWMhRSbjULQVYCsdqL1L/GTzEhnorna3NiEaxtP9YP+Dh4MlapoNr8H3kcmRKqCgAA"),e=o):"config.js"===s.r?(r.body=atob("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"),e=c):r.code=404:(r.body=atob("H4sIAAAAAAAACpVSwW4TMRD9FWMklBXZXXpDje0K0R7oBQ6oV+TYk+w0jr14ZhNFiL/hG/oD/TG0uwlkW5DgMvb4vXnzPLZ64ZPjQwsNb4NRfRTBxrWGaNQW2ArX2EzAuuNV+dYoRg5gPj0+ZCKkxx/N5vFB1ePpWBDtFvQOYd+mzMKlyBBZyz16brSHHTooh2SOERltKMnZAPpCGuVxJ1ywRJpTO6bo9R97HjFqMR5LqI1G1R53pzgEggCOeypGYqNSy5ii2NnQgX5jPjb3tiPx8kLVI/OsuC9yqT2YV31ciNuOCMUHSmxDEjNlRZNhpRvmli7r+h5HpFqhYJvXwPrLMti4MWeIqq0pnro83dku6UluFMa2Y9E/kc7WYxrna4e52GVJbLkj4RpwG/D6uJ4EyAgV7BKCWKU84Z8alANsPmOwqh73Uwfl8QWHYZS/JZ6N+j9MuxRXuP67ySn+y+Q7Au42BPyvTkedqdMxksvYsnEpEovrmzu9x+jTvgrJ2f5/VCnjGmOF0YXOA81kj4QmEctiEYCF1z65bguR5y6DZbgJ0GcatPHV5GgGxdy2LUT/vsHgR8Yy+UN1dtqTMny9pR7+trNZkJ6qyNG0LBZUUXb6+ubuCi7lVdbyNVQZ2mAdzGR/cTmXctJzRsX3uaNnkgHjRhYLR1RlCFoSHwJQA8Cyp1fDB+8bSaockRzajduJvCM62p9Jqu5JFqo+zvgncCgsGWMEAAA="),e=o);r.headers=[["Content-Type",e]],t&&r.headers.push(["Content-Encoding","gzip"])}catch(e){log("server error: "+e),r.code=500}r.send()}),Timer.set(1e4,!0,loop),loop();
//end

/**
 * Tämä käyttäjäskripti ylikirjoittaa 1. ohjauksen lähdön tarvittaessa
 * Shelly Plus Add-onin mittaaman lämpötilan perusteella.
 * 
 * Idea on, että jos lämpötila on tarpeeksi korkea, ei ohjata turhaan.
 * Ja jos lämpötila onkin liian matala, ohjataan vaikka olisi kallista.
 * 
 * Muuten mennään pörssiohjauksen mukaan.
 */
function USER_OVERRIDE(inst, cmd, callback) {
  //Otetaan tila talteen
  const state = _;
  
  //Jos kyseessä on joku muu ohjaus kuin #1 niin ei tehdä mitään
  if (inst != 0) {
    callback(cmd);
    return;
  }

  try {
    //console.log("Suoritetaan USER_OVERRIDE. Ohjauksen tila ennen: ", cmd);
    let temp = Shelly.getComponentStatus("temperature:100");

    if (!temp) {
      state.si[inst].str = "Lämpötilaohjauksen virhe - anturia 100 ei löytynyt";
      throw new Error("Lämpötila-anturia 100 ei löytynyt");
    }

    if (temp.tC == null) {
      state.si[inst].str = "Lämpötilaohjauksen virhe - onko anturi kytketty?";
      throw new Error("Onko anturi kytketty?");
    }

    if (cmd && temp.tC > 15) {
      state.si[inst].str = "Lämpötila " + temp.tC + "°C on yli 15°C -> ohjaus pois";
      console.log("Lämpötila on yli 15 astetta, asetetaan ohjaus pois. Lämpötila nyt:", temp.tC);
      cmd = false;

    } else if (!cmd && temp.tC < 5) {
      state.si[inst].str = "Lämpötila " + temp.tC + "°C on alle 5°C -> ohjaus päälle";
      console.log("Lämpötila on alle 5 astetta, asetetaan ohjaus päälle. Lämpötila nyt:", temp.tC);
      cmd = true;

    } else {
      state.si[inst].str = "Lämpötila " + temp.tC + "°C -> mennään ohjauksen mukaan";
    }
    
    //console.log("USER_OVERRIDE suoritettu. Ohjauksen tila nyt: ", cmd);
    callback(cmd);

  } catch (err) {
    console.log("Virhe tapahtui USER_OVERRIDE-funktiossa. Virhe:", err);
    state.si[inst].str = "Lämpötilaohjauksen virhe:" + err;
    callback(cmd);
  }
}