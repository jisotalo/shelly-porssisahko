/**
 * @license
 *
 * shelly-porssisahko
 * shelly-porssisahko-en
 *
 * (c) Jussi isotalo - http://jisotalo.fi
 * https://github.com/jisotalo/shelly-porssisahko
 * https://github.com/jisotalo/shelly-porssisahko-en
 *
 * License: GNU Affero General Public License v3.0
 */
let SLOT=3600;const CNST={INST:"undefined"==typeof INSTANCE_COUNT?3:INSTANCE_COUNT,HIST:"undefined"==typeof HIST_LEN?24:HIST_LEN,ERRC:3,ERRT:120,DINS:{cTs:0,st:0,str:"",cmd:-1,cOK:0,fTs:0,fCmd:0},DCFG:{COM:{g:"fi",vat:25.5,day:0,nite:0,q:0,nms:[]},INST:{en:0,mode:0,m0:{c:0},m1:{l:0},m2:{p:24,c:0,l:-999,s:0,m:999,ps:0,pe:23,ps2:0,pe2:23,c2:0},b:0,e:0,o:[0],f:0,fc:0,i:0,m:60,oc:0}}};let _={s:{v:"4.0.0-alpha.5",dn:"",cOK:0,tOK:0,eCnt:0,eTs:0,upTs:0,tz:"+02:00",tzh:0,enC:0,p:[{ts:0,now:0,low:0,high:0,avg:0},{ts:0,now:0,low:0,high:0,avg:0}]},si:[CNST.DINS],ps:[0,0],pv:[[],[]],h:[],c:{c:CNST.DCFG.COM,i:[CNST.DCFG.INST]}},_i=0,_j=0,_k=0,_inc=0,_cnt=0,_st=0,_end=0,cmd=[],pEp=0,lRun=!1,lTmr=null;function restartLoop(e){lTmr&&(Timer.clear(lTmr),lTmr=null),lTmr=Timer.set(e,!1,loop)}function getKvsKey(e){let t="porssi";return t=0<=e?t+"-"+(e+1):t}function limit(e,t,s){return Math.min(s,Math.max(e,t))}function epoch(e){return Math.floor((e?e.getTime():Date.now())/1e3)}function getDate(e){return e.getDate()}function clearPrice(e){for(_.pv[e].splice(0),_.ps[e]=0,_.s.p[e].ts=0,_i=0;_i<CNST.INST;_i++)0===e?_.si[_i].slots0="":1===e&&(_.si[_i].slots1="")}function updateTz(e){let t=e.toString(),s=0;"+0000"==(t=t.substring(3+t.indexOf("GMT")))?(t="Z",s=0):(s=+t.substring(0,3),t=t.substring(0,3)+":"+t.substring(3)),t!=_.s.tz&&(clearPrice(0),clearPrice(1)),_.s.tz=t,_.s.tzh=s}function log(e){console.log("shelly-porssisahko: "+e)}function reqLogic(){for(let e=0;e<CNST.INST;e++)_.si[e].cTs=0}function updateState(){var e=new Date,t=(_.s.tOK=null!=Shelly.getComponentStatus("sys").unixtime&&2e3<e.getFullYear(),_.s.dn=Shelly.getComponentConfig("sys").device.name,_.s.dn||(_.s.dn=Shelly.getDeviceInfo("info"),_.s.dn&&_.s.dn.app&&_.s.dn.mac?_.s.dn=_.s.dn.app+"-"+_.s.dn.mac:_.s.dn=""),epoch(e));for(_.s.tOK&&300<Math.abs(t-pEp)&&(log("Time changed 5 min+ -> refresh"),clearPrice(_.s.p[0].now=0),clearPrice(1)),pEp=t,_.s.enC=0,_i=0;_i<CNST.INST;_i++)_.c.i[_i].en&&_.s.enC++;!_.s.upTs&&_.s.tOK&&(_.s.upTs=epoch(e))}function getConfig(p){let a=getKvsKey(p);Shelly.call("KVS.Get",{key:a},function(t,e,s){p<0?_.c.c=t?JSON.parse(t.value):{}:_.c.i[p]=t?JSON.parse(t.value):{},"function"==typeof USER_CONFIG&&USER_CONFIG(p,!0);{var n=p,o=function(e){p<0?(_.s.cOK=e?1:0,SLOT!==(1===_.c.c.q?900:3600)&&(log("Slot length set to "+(SLOT=1===_.c.c.q?900:3600)+"s ("+(900===SLOT?"15 min":"hourly")+")"),clearPrice(0),clearPrice(1))):(log("config for #"+(p+1)+" read, enabled: "+_.c.i[p].en),_.si[p].cOK=e?1:0,_.si[p].cTs=0,_.c.i[p].en&&(_.si[p].slots0=buildSlotCharmap(p,0),0<_.pv[1].length&&(_.si[p].slots1=buildSlotCharmap(p,1)),log("slot array updated for instance #"+(p+1)))),lRun=!1,restartLoop(500),a=null,t=null};let e=0;if(CNST.DCFG.COM||CNST.DCFG.INST){var i,r=n<0?CNST.DCFG.COM:CNST.DCFG.INST,l=n<0?_.c.c:_.c.i[n];for(i in r)if(void 0===l[i])l[i]=r[i],e++;else if("object"==typeof r[i])for(var c in r[i])void 0===l[i][c]&&(l[i][c]=r[i][c],e++);n>=CNST.INST-1&&(CNST.DCFG.COM=null,CNST.DCFG.INST=null),0<e?(n=getKvsKey(n),Shelly.call("KVS.Set",{key:n,value:JSON.stringify(l)},function(e,t,s,n){t&&log("failed to set config: "+t+" - "+s);try{n(0==t)}catch(e){log("chkConfig callback error: "+e),lRun=!1,restartLoop(1e3)}},function(e){lRun=!1,restartLoop(1e3)})):(lRun=!1,restartLoop(1e3),o(!0))}else o(!0)}})}function loop(){try{if(!lRun)if(lRun=!0,updateState(),_.s.cOK)if(pricesNeeded(0))getPrices(0);else if(pricesNeeded(1))getPrices(1);else{for(let e=0;e<CNST.INST;e++)if(!_.si[e].cOK)return void getConfig(e);for(let e=0;e<CNST.INST;e++)if(function(e){var t=_.si[e],s=_.c.i[e];if(1!=s.en)return void _.h[e].splice(0);var e=new Date,n=new Date(1e3*t.cTs);var o=Math.floor(t.cTs/SLOT),i=Math.floor(epoch(e)/SLOT);return 0==t.cTs||o!=i||n.getFullYear()!=e.getFullYear()||0<t.fTs&&t.fTs-epoch(e)<0||0==t.fTs&&s.m<60&&e.getMinutes()>=s.m&&t.cmd+s.i==1}(e))return void Timer.set(500,!1,logic,e);"function"==typeof USER_LOOP?USER_LOOP():lRun=!1}else getConfig(-1)}catch(e){log("error at main loop:"+e),lRun=!1}}function pricesNeeded(e){var t=new Date;let s=!1;return s=1==e?_.s.tOK&&0===_.s.p[1].ts&&15<=t.getHours():((e=getDate(new Date(1e3*_.s.p[0].ts))!==getDate(t))&&clearPrice(1),_.s.tOK&&(0==_.s.p[0].ts||e)),_.s.eCnt>=CNST.ERRC&&epoch(t)-_.s.eTs<CNST.ERRT?s=!1:_.s.eCnt>=CNST.ERRC&&(_.s.eCnt=0),s}function getPrices(f){try{log("fetching prices for day "+f);let o=new Date;updateTz(o);var e=1==f?new Date(864e5+new Date(o.getFullYear(),o.getMonth(),o.getDate()).getTime()):o;function t(e,t,s,n){return e.getFullYear()+"-"+(e.getMonth()<9?"0"+(1+e.getMonth()):1+e.getMonth())+"-"+(getDate(e)<10?"0"+getDate(e):getDate(e))+"T"+(t<10?"0"+t:t)+":"+(s<10?"0"+s:s)+":"+(n<10?"0"+n:n)+_.s.tz.replace("+","%2b")}let i=[{strt:t(e,0,0,0),end:t(e,11,59,59)},{strt:t(e,12,0,0),end:t(e,23,59,59)}];function m(e){log("error getting prices: "+e),_.s.eCnt+=1,_.s.eTs=epoch(),clearPrice(f),0==f&&reqLogic(),lRun=!1,restartLoop(500)}_.pv[f].splice(0),_.s.p[f].avg=0,_.s.p[f].high=-999,_.s.p[f].low=999,!function e(t){if(t>=i.length){var s=_.pv[f].length;_.s.p[f].avg=0<s?_.s.p[f].avg/s:0,_.s.p[f].ts=epoch(o);var n=(n=86400/SLOT)-Math.max(1,3600/SLOT);if(s<n)log("invalid data: got "+s+" slots, expected ≥ "+Math.floor(n)),m("insufficient slot count"),i=null;else{for(_i=0;_i<CNST.INST;_i++)_.c.i[_i].en&&(0===f?_.si[_i].slots0=buildSlotCharmap(_i,0):1===f&&(_.si[_i].slots1=buildSlotCharmap(_i,1)));log("slot arrays updated after price data for dayIndex="+f),lRun=!1,restartLoop(500),i=null,o=null}}else s={url:"https://dashboard.elering.ee/api/nps/price/csv?fields="+_.c.c.g+"&start="+i[t].strt+"&end="+i[t].end,timeout:5,ssl_ca:"*"},Shelly.call("HTTP.GET",s,function(o,i,r){try{if(0!==i||!o||200!==o.code||!o.body_b64)throw Error("HTTP error: "+i+" ("+r+") - "+JSON.stringify(o));o.headers=null,o.message=null,i=r=o.code=null,o.body_b64=atob(o.body_b64),o.body_b64=o.body_b64.substring(1+o.body_b64.indexOf("\n"));let e=0,t=0,s=-1,n=[-1,0];function l(){t<=0||(n[1]=n[1]/t,0===_.pv[f].length&&(_.ps[f]=n[0]),_.pv[f].push(n[1]),_.s.p[f].avg+=n[1],n[1]>_.s.p[f].high&&(_.s.p[f].high=n[1]),n[1]<_.s.p[f].low&&(_.s.p[f].low=n[1]),t=0,n[1]=0)}for(;0<=e;){o.body_b64=o.body_b64.substring(e);var c=[e=0,0];if(0==(e=1+o.body_b64.indexOf('"',e))){0<t&&l();break}c[0]=+o.body_b64.substring(e,o.body_b64.indexOf('"',e)),e=2+o.body_b64.indexOf('"',e),e=2+o.body_b64.indexOf(';"',e),c[1]=+(""+o.body_b64.substring(e,o.body_b64.indexOf('"',e)).replace(",",".")),c[1]=c[1]/10*(100+(0<c[1]?_.c.c.vat:0))/100;var p=new Date(1e3*c[0]).getHours(),a=(c[1]+=7<=p&&p<22?_.c.c.day:_.c.c.nite,e=o.body_b64.indexOf("\n",e),Math.floor(c[0]/SLOT)*SLOT);s<0&&(n[0]=c[0],s=a),a!==s&&(l(),n[0]=c[0],s=a),n[1]+=c[1],t++}0<t&&l(),row=o=null,order=null,n=null}catch(i){return void m("chunk "+t+" parse error: "+i)}e(t+1)})}(0)}catch(e){m("setup error: "+e)}}function logic(c){try{"function"==typeof USER_CONFIG&&USER_CONFIG(c,!1),cmd[c]=!1;let i=new Date,r=(updateTz(i),!_.s.tOK||0==_.s.p[0].ts||!_.ps[0]||0===_.pv[0].length||(n=epoch(),(o=n-_.ps[0])<0)?_.s.p[0].now=0:0<=(p=Math.floor(o/SLOT))&&p<_.pv[0].length?_.s.p[0].now=_.pv[0][p]:p===_.pv[0].length&&o-_.pv[0].length*SLOT<60?_.s.p[0].now=_.pv[0][_.pv[0].length-1]:(log("updateCurrentPrice: out-of-range idx="+p+", SLOT="+SLOT),_.s.tOK=!1,clearPrice(0),_.s.eCnt++,_.s.eTs=n),_.si[c]),l=_.c.i[c];var e,t;function s(e){if(null==e)lRun=!1;else if(cmd[c]!=e&&(r.st=12),cmd[c]=e,l.i&&(cmd[c]=!cmd[c]),log("logic for #"+(c+1)+" done, cmd: "+e+" -> output: "+cmd[c]),1==l.oc&&r.cmd==cmd[c])log("outputs already set for #"+(c+1)),r.cmd=cmd[c]?1:0,r.cTs=epoch(),lRun=!1;else{let n=0,o=0;for(let e=0;e<l.o.length;e++)!function(e,o,i){e="{id:"+o+",on:"+(cmd[e]?"true":"false")+"}",Shelly.call("Switch.Set",e,function(e,t,s,n){0!=t&&log("setting output "+o+" failed: "+t+" - "+s),i(0==t)},i)}(c,l.o[e],function(e){if(n++,e&&o++,n==l.o.length){if(o==n){if(r.cmd!=cmd[c]){for(var t=c,s=0<_.s.enC?CNST.HIST/_.s.enC:CNST.HIST;0<CNST.HIST&&_.h[t].length>=s;)_.h[t].splice(0,1);_.h[t].push([epoch(),cmd[t]?1:0,_.si[t].st])}r.cmd=cmd[c]?1:0,r.cTs=epoch(),restartLoop(500)}lRun=!1,i=null,l=null,r=null}})}}0===l.mode?(cmd[c]=1===l.m0.c,r.st=1):_.s.tOK&&0<_.s.p[0].ts&&getDate(new Date(1e3*_.s.p[0].ts))===getDate(i)?1===l.mode?(cmd[c]=_.s.p[0].now<=("avg"==l.m1.l?_.s.p[0].avg:l.m1.l),r.st=cmd[c]?2:3):2===l.mode&&(cmd[c]=function(e){var t=_.c.i[e];t.m2.ps=limit(0,t.m2.ps,23),t.m2.pe=limit(t.m2.ps,t.m2.pe,24),t.m2.ps2=limit(0,t.m2.ps2,23),t.m2.pe2=limit(t.m2.ps2,t.m2.pe2,24),t.m2.c=limit(0,t.m2.c,0<t.m2.p?t.m2.p:t.m2.pe-t.m2.ps),t.m2.c2=limit(0,t.m2.c2,t.m2.pe2-t.m2.ps2);var e=3600/SLOT,s=Math.floor(t.m2.ps*e),n=Math.floor(t.m2.pe*e),o=Math.floor(t.m2.ps2*e),i=Math.floor(t.m2.pe2*e),r=Math.floor(t.m2.c*e),l=Math.floor(t.m2.c2*e),c=t.m2.p<0?t.m2.p:Math.floor(t.m2.p*e);var p=_.pv[0];if(p&&0!==p.length&&_.ps[0]){var a=[];for(_inc=c<0?1:c,_i=0;_i<p.length;_i+=_inc)if(!((_cnt=-2==c&&1<=_i?l:r)<=0)){var f=[];for(_st=_i,_end=_i+c,c<0&&0==_i?(_st=s,_end=n):-2==c&&1==_i&&(_st=o,_end=i),_j=_st;_j<_end&&_j<p.length;_j++)f.push(_j);if(0!==f.length){if(t.m2.s){for(_avg=999,_sId=0,_j=0;_j<=f.length-_cnt;_j++){for(_sum=0,_k=_j;_k<_j+_cnt;_k++)_sum+=p[f[_k]];_sum/_cnt<_avg&&(_avg=_sum/_cnt,_sId=_j)}for(_j=_sId;_j<_sId+_cnt;_j++)a.push(f[_j])}else{for(_j=0,_k=1;_k<f.length;_k++){var m=f[_k];for(_j=_k-1;0<=_j&&p[m]<p[f[_j]];)f[_j+1]=f[_j],_j--;f[_j+1]=m}for(_j=0;_j<_cnt&&_j<f.length;_j++)a.push(f[_j])}if(-1==c||-2==c&&1<=_i)break}}var e=epoch(),u=Math.floor((e-_.ps[0])/SLOT);if(!(u<0||u>=p.length))for(let e=0;e<a.length;e++)if(a[e]===u)return!0}return!1}(c),r.st=cmd[c]?5:4,!cmd[c]&&_.s.p[0].now<=("avg"==l.m2.l?_.s.p[0].avg:l.m2.l)&&(cmd[c]=!0,r.st=6),cmd[c])&&_.s.p[0].now>("avg"==l.m2.m?_.s.p[0].avg:l.m2.m)&&(cmd[c]=!1,r.st=11):_.s.tOK?(r.st=7,e=1<<i.getHours(),(l.b&e)==e&&(cmd[c]=!0)):(cmd[c]=1===l.e,r.st=8),_.s.tOK&&0<l.f&&(t=1<<i.getHours(),(l.f&t)==t)&&(cmd[c]=(l.fc&t)==t,r.st=10),cmd[c]&&_.s.tOK&&i.getMinutes()>=l.m&&(r.st=13,cmd[c]=!1),_.s.tOK&&0<r.fTs&&(0<r.fTs-epoch(i)?(cmd[c]=1==r.fCmd,r.st=9):r.fTs=0),"function"==typeof USER_OVERRIDE?USER_OVERRIDE(c,cmd[c],s):s(cmd[c])}catch(e){log("error running logic: "+JSON.stringify(e)),lRun=!1}var n,o,p}let _avg=999,_sId=0,_sum=0;function buildSlotCharmap(e,t){var s=_.pv[t];if(!s||0===s.length)return"";var n=_.c.i[e],o=_.s.p[t].avg,i=n.mode,r=function(e,t){var e=_.c.i[e],s=_.pv[t],t=_.ps[t],n=s?s.length:0;if(0===n||!t)return[];(t=e.m2).ps=limit(0,t.ps,23),t.pe=limit(t.ps,t.pe,24),t.ps2=limit(0,t.ps2,23),t.pe2=limit(t.ps2,t.pe2,24),t.c=limit(0,t.c,0<t.p?t.p:t.pe-t.ps),t.c2=limit(0,t.c2,t.pe2-t.ps2);var e=3600/SLOT,o=Math.floor(t.ps*e),i=Math.floor(t.pe*e),r=Math.floor(t.ps2*e),l=Math.floor(t.pe2*e),c=Math.floor(t.c*e),p=Math.floor(t.c2*e),a=t.p<0?t.p:Math.floor(t.p*e),f=[];for(let e=0;e<n;e++)f[e]=0;for(_inc=a<0?1:a,_i=0;_i<n;_i+=_inc)if(!((_cnt=-2==a&&1<=_i?p:c)<=0)){_st=_i,_end=_i+a,a<0&&0==_i&&(_st=o,_end=i),-2==a&&1==_i&&(_st=r,_end=l);var m=[];for(_j=_st;_j<_end&&_j<n;_j++)m.push(_j);if(0!==m.length){for(_k=1;_k<m.length;_k++){var u=m[_k];for(_j=_k-1;0<=_j&&s[u]<s[m[_j]];)m[_j+1]=m[_j],_j--;m[_j+1]=u}for(_j=0;_j<_cnt&&_j<m.length;_j++)f[m[_j]]=1;if(-1==a||-2==a&&1<=_i)break}}return f}(e,t),l=s.length,c=n.f,p=n.fc,a=Array(l);for(let t=0;t<l;t++){let e=0;var f,m=s[t];0===i?n.m0.c&&(e=5):1===i?m<=("avg"==n.m1.l?o:n.m1.l)&&(e=2):2===i&&(f="avg"==n.m2.l?o:n.m2.l,r[t]?e=1:m<=f&&(e=2)),0<c&&c&(m=1<<(t*SLOT/3600|0))&&p&m&&(e=3),a[t]=e}return a.join("")}log("v."+_.s.v),log("URL: http://"+(Shelly.getComponentStatus("wifi").sta_ip??"192.168.33.1")+"/script/"+Shelly.getCurrentScriptId()),_.c.i.pop(),_.si.pop();for(let e=0;e<CNST.INST;e++)_.si.push(Object.assign({},CNST.DINS)),_.c.i.push(Object.assign({},CNST.DCFG.INST)),_.c.c.nms.push("-"),_.h.push([]),cmd.push(!1);CNST.DINS=null,pEp=epoch(),SLOT=1===_.c.c.q?900:3600,HTTPServer.registerEndpoint("",function(s,n){try{if(lRun)return s=null,n.code=503,void n.send();var o=function(e){var t={},s=e.split("&");for(let e=0;e<s.length;e++){var n=s[e].split("=");t[n[0]]=n[1]}return t}(s.query),i=parseInt(o.i);s=null;let e="application/json",t=(n.code=200,!0);var r,l="text/html",c="text/javascript";if("s"===o.r)updateState(),0<=i&&i<CNST.INST&&(r={s:_.s,si:_.si[i],c:_.c.c,ci:_.c.i[i],p:[{ps:_.ps[0],pv:_.pv[0]},{ps:_.ps[1],pv:_.pv[1]}],slot:SLOT},n.body=JSON.stringify(r)),t=!1;else if("c"===o.r)updateState(),0<=i&&i<CNST.INST?n.body=JSON.stringify(_.c.i[i]):n.body=JSON.stringify(_.c.c),t=!1;else if("h"===o.r)0<=i&&i<CNST.INST&&(n.body=JSON.stringify(_.h[i])),t=!1;else if("r"===o.r){if(0<=i&&i<CNST.INST)log("config changed for #"+(i+1)),_.si[i].cOK=!1;else{log("config changed");for(let e=0;e<CNST.INST;e++)_.si[e].cOK=!1}_.s.cOK=!1,reqLogic(),lRun||(lRun=!0,getConfig(i)),clearPrice(0),clearPrice(1),n.code=204,t=!1}else"f"===o.r&&o.ts?(0<=i&&i<CNST.INST&&(_.si[i].fTs=+(""+o.ts),_.si[i].fCmd=+(""+o.c),_.si[i].cTs=0),n.code=204,t=!1):o.r?"s.js"===o.r?(n.body=atob("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"),e=c):"s.css"===o.r?(n.body=atob("H4sIAAAAAAAAA41WTW/jNhD9K8QGBZJsZEvxOnVk1GhPCxTdopf2UvRAUUOLNUUKJBXbu8h/75CiZNpxsL3Y0nA+3sybGWp+f0/uiW1AymPWaWOtsLTZaeLFt+yO/NqjiAirHZWaZKRxrivn83+jZMYFKnqhRelWuKavZky3k8L8Hd+/CQbKQkk+//4n+YVzMJp8BgWGSvJHX0nBRhXyspjl5H6ORt9IpQ+ZFV+F2pb4bGowGYrW5BXf6uMDoajDtNSmJDfAeM6L8cwbU7bbGt2rGk8f2QKW+ZpIoSBrQGwbV5Ji9gnaNeFaOR8G4eWz50nCaSvksSR/gampomvS0kO2F7VrSvLp2Xi9+Fbk+Q/+2GyFQh+E9k6vSUfrOiBfdgdU6QLuGyecBESXBI0wBntM0DndBqtgwHR3PNfPZyuvT6XYqsyC5CXhEg4ZqHpNHBxcFo5KYnya3smMywP6qIXtJD0O6kHuaGXxoNNWOKG9CUjqxAusz8tX0Io9s8mkLCvg2sDD+Eq5AxPIUA4UlvbDh/UpHOpISIwnbQnUeGZdM576TKWm6EECH7A7i2GaFL7SanKXSVqBTE8rqdnugunH2Y9LX7OJkxyr/uglsa1M1EOqrJaixpSfaL5argnrjfUN1mmBuZkpbkwVI591wamUmKqWvUOkXzOhajigCvKjuxMcnyNiSXAVoa/Oas85X09dPvax7igT7hiMQ41K1gDbQf3xrCjfdzTkf8VPcPHxItUpbJFk9TiY6i5lYWsEdqP/zRy0KHOAfmTfKovW3IQh8Q/B2HYqKeTsMVThNKbD+wQ1vEeenKHKdtQgvonMMcexa6MYEY5H+0Z4YkbyaS16hLX0BFIlWjow6FEVNnQSNUQoLlQwm5IUKnRZ7LhX8vMOjtzQFiwZMvI9gX8BJA4MjrXBPengdvGU17C9Q5vXYTxmjG2c31wbZzauLrkw1mWsEbLG9q+2D1HNtugtPR13wz5Wq9ISC/8CxglG5bgKMPf3Rxq3Q9Zqz7MM84e7pBYGWFwJeh9ya6EW9DZdgitcandocXVHPXnK0m00DHTccmEMslV3SHrnO80yam5IqVwzJH+78PHn9+QL3eH8ENcAWZiaDMZkqzFxohBEIBFvlRBjOEXPZE6ycGUMtW1TBh7ITbXbvLddzmb+qv0FRzHvOPE+71NXhumb7rdh/eeJ27eMp7YF7qxKIrXDRPwPRof8LxU3tXiZgEYAEcIpovULICzQdNok7fzlPj69Lc8J8xW86UU5kMz8zCStg18G4+rlIl256D2McsAF/mbYG9oFxX2xyhPN1ei8dUV+4mOoYLycfTWKWK+w4ry6WaZFCZd5HrdlK5eXzI5RKmwfm7H2nfF8xdXR9e5vd+zgp6pHytU/lx8FhR+g19PYf7vyoRKzG8fjtCJ83KmuCw/qej1t3yJ+P7xv77n/AHPmnH4uCgAA"),e="text/css"):"status"===o.r?(n.body=atob("H4sIAAAAAAAAA5WSTW7CMBCFr2Jl1SKRkEWlLoIPUFXqolxg4hjFxD9pPIFyH87QC+RiHRxiQUt/WNiLmfe+eWO5QCi1ZEKD98vEMCESXmBHp+LPoFCyDTBXb6D3VGKqWvp5ZSfJybfLHxf8JYiY3WMUCnOEVIAANk3TiRuUjZeWealpRNR7jLNfh0PdDB+W1coiXFCt2/ELlMf9vm1VFBhXyahYKQ2xo+za8SILO/OiUttp8bV+Z3TIWs6F08lFE8WxlzPTPXxrGMwXVCynwAyHgx0OdBVZSaNITTHCG4cErVpcDXCOWjmUPfYGfoGNNnKN1DPoqLoWX/8jft07I62Fn9LnN6T/g5V/zTzevm/5bNZC07j56eNlx1qYF5zbuH30iE61yDv59uTvEoLSVwLsfbrxyT3Zx/YnFqn0K+wCAAA="),e=l):"status.js"===o.r?(n.body=atob("H4sIAAAAAAAAA4VW3XLaOBS+36dQ1CyVYscxbae7GxBM/3bYKZl2NszsBcMsiq2AGiODJUgZ8F0fJc+wL8CL7ZGMwUmhzQA5ko6OP5/z6TtaRanSBnH2vGmyVtPEKEoTPeWK4Ze49UGihRTJ5gEZKeJUa968MHELfrLWc/+GEcpaqwXPkGGGtWaaGBpIpUTW6V11GcYNQ7A+jyYxpj6slnagzTIRATwpzRh+FoYh9p1nrMDRWSq9L81JGovSnoY7S+7N+n5yZ0p1m5a2NpjmDYszYlwvVQR4WyuTLVfylpj1epHKGIWMMW24EfSGPEZbeaMuj7nhXAVBgBsi0cJGOCm2mXGW3qMPWZZmBKsUWU9MG4kwSBeR/Q7TgXZABFiRW5vZOekmlZ2UbrZrZ5MUwL18HYa+YUQFQrXJYVyzAGba+PPm2+Zbt7v5hi/x509/XeOjSd9uGGVCKHDORFz6FtmuxL769P7Dv9e9v/sqsGuDrZ8rUMVNB9N+OAimi1otbO4GQSLUyIzbnWICNgUm/VN+FTF5QT2Moou7f8YAoHy6rVQl6B9QkxkAb1/33vQKFHY4CDIxTXgkCP5VY/82zSbcvIcE9+REECXukR2Qunh5Ngtue5r6J3VKL58E8SClso0Ruds8bB6UEVIJRS0Y6mN84h6c1WrkEDKP4eYNnBf4Ys85lpQpeFd5h7AJye7pNv40/sLnGhme3UlthDFzhL0C+yHcsAcw417pDqxDqQthuKUfvSR7on73VAxHF95raTb/ab15wEcIPdyCena6kqADXj1HQqI0EdXNw+Nn1x5d6neCWK3XuCmtYHAt3Ms1L2QL6C8CNdF9G3wAuTSQOLSG965MwyH12BCR9CkUWj7YykIFtDny0jb2OcQmYXPLNwNp78A6N2i6eZALaZEtf5D2K27GwYR/JbsAvrXq1qK2HBDNpF84GnNR6kBZg8XjzH6EBCpVVHqJTlc/YmknmE9tuXNHRrcN8g6bCNk50mAkCsT0/NDm/TK9gOmL16H9vHhFdycOgzjmRSIs4ykkayEyLVM09DrBwkmQtELuJF1XWkLCtWbYoJsRbn0U+k7ybJEWreDpcocnC6kOr33kSSLKRddDGpkw80xZ8TW2Wtrjl9ob/oK2fxbBbmCHcet0ZQK+GFV0JC9kxIU94Jw8Ep2fOI/laPwzbwd9mPsZ22qD60WV2sstfUpmuLb03Xod1onwTdlDFXuODmb8jbzjR5INbDyyVBzsaruWTqOFlWWAXtq6AR0sPGGdYmx0rSZBwk8Yk1vxrtUy6gCmrK8Gfsws86yUk7K5QaO33VPUahiUUKoRhnIupyK9RTPXxXTY1qw0L+s/9q2DTuy869TRMmF96BHbz9kZ/LyF7xUeNOBYEYvCsLBhmiXmhvG8AnTEMs+cdf0ek30z8Kfs0dmJqB+xLXY3brK4Voub1iaR16X+hBHdD9dmAAJnqxyNefYO+uAbQ0J6/up3fwEKP2mkwXSux2QIBUROIRk+XUVtfJsqc34vgFXm8iZN4obtLzmuUm9Lv7J8t9LgVikX7kBPbfvKnzJ2z9rez+m9d160ce3Z1xe/1V8VUEBkkv7Evh0+8IiC6jS3mRyzNPiSSkWgQTbMns5AlbGV9grBxzS3lyNUnVMez2kjI2F5KCCb1M9IvRzX7VizDpsxNU8Sv+v+5XnETTSGm+XKXlWhNQXCXbEM9Y9f1IY9mXDbysp7KyL2dE8EmCOx7ywHWpq9C+V5I4LY795eQ8womcdCk4iu13bC1Tmi+f/luUiZOgsAAA=="),e=c):"history"===o.r?(n.body=atob("H4sIAAAAAAAAA2WOuw7CMAxFfyXKBEOI2NNIrCwMfEFeUBejQGwQ/XtMeQipg23pnCvbLsNdJQxEnT7gQ0mZc40mVdTe/UlOL7cWyCFikdGk8k+reNR+A6cwg7t+CDea4X1B4OLstCfWPCrIHZkeiL3Q9xErH3w7pQYX9q1ct7TQEpiytY2rgfTS2Y9/AkYQ4FXSAAAA"),e=l):"history.js"===o.r?(n.body=atob("H4sIAAAAAAAAA1VS227bMAz9FZVoB2l2vHbBXurIwS4F9tBiQOM9BUHLOEysTbUyiWkRuP6b/kl/bLKDAikgEBB5dA55qNYSC6Pni7xyTWCx1KyL9l+QEEa1CQwqM01D/md5c61hwr6Y8EpUzoYtNnpcXBnRw5w3iJNPvCpi8AV0+SN6UWkM+6YSPWV/9/qYOGe/b81a8vNzs7NW68DIpDzxzjdiKVUei8C4HB0U9qA1VmweqcSlGggpRY1PaFhsiH8go/x9ez1LYOp1/cFoSEycaeDBzP1VvdqJNBqzVcSqzFKz4fpIsSMbSETUl/PxSVTLKrd615E/dgPytfOShFsLkwXnWUpOvdKFn58vRhyDOrQZDs5BGrTsT6LvBxcthlhaG4bitI1cD8ileSDZ0JOI05C8oPFHGni6wdx7lQwvA+8taYhrcP7ytKX5xWIKG0/UwCV4WkHXMx7Sv+o/uAti+/ry+mItRcBbxpkA73jjm1n5tby6m5W3c5p/XiymmaetxYokCHkWBAY2ClKAt4YSOCz82JlEh67rKuSqlqza/mM5Sxl5H+1ilR6byF2XV1Kl37/Nsu0u1LJS3X/wNQ4RlAIAAA=="),e=c):"config"===o.r?(n.body=atob("H4sIAAAAAAAAA5VW21LjNhh+FY07nYUL5yDoLpNJNOOL3UkgJJ0m0OmlIgusWJaMJYem132UPAMvkBerbNmJrRDozoDB//HT9x/kYcg2gIUj8vTsc0A4VmqkCZriEGuMRafTGXaNCRoe7YDSW05HIVMpx9uBkIJatfX2NAErz9o8SaF9xf6hg34H0gT9Nf0+WXxfgsA8Hu7Mowqu8YrT2j8BhHhGlpnfEN1jXPwZKsop0QWEZzSUqWZSgA3muUnC0CKXCWtLKUWPLJNtId+Yk+kNw45YoymjWud42LV56vQVptf+TQ8t9rso3r8JEEwfS0hMpHmJaIM1KE45ukLg1xr4grFMywTHKtfFe++bD+EAHL1CvD14kW78Z9QgMdH9HoLQ731regimqeNS8WdTPuJMa6YszgZEvU3piESUxCv5dxHoBQ27Jedu4Yq8Z6s3H98GDwvwy1ClWJTNwEyc4gV9WscmkXf73Vbv35QBWoLkeEX5WaxUIDCfdec/fgy7lWV13BkzRW8VQhx082iNc6Vx6nZPIkOK3DKX5lrjopDc0Bfu33Q7ssy1stRfH5ym1lIAWSZzEkni9GkPBUxgoHEWM4OMKuW0Yd8UkAmQ5LlpxVL9HsxcJUwYE+YgNNJDb5j/axdD9n4nNGWCtoCeYZuJVjsZLErnQpTJCv0qPqjH+502P4zjRthPapll54r5O45j6ZeRYkXt2UKqMeOqngn+m+E3TxKcbdGs7KFdN2WMS10wVSmqHjTJnqK6E1VSNrZ37PpuFfrdOaiGwFD372Jim/6n+nv+f+lIej5JwhNGPoA0nsyWwR/BbfBTgMZMmK7Da+x0TN/nLHEXyvnkt8HdYj4DY7P/Jvf3wRIsH2azyec7vAklWGOxNjtRumMJ/ZRmzsTAawSvI2dIIOpDR3aDbhzJV/TVkVwjN9IVunIkELmR/T4yK7x4KSgEF31Qgr90rGDbClorfHkYYGB3piUiQpjFeLPfcQYuYi4vB/UW1Vnd69AnduJNXNzi7Fg+Q5mqqzfo9YAP2kraUNZjtsyFZkmxE7Jq+zZdiDheZFEbDTyFA+A7gOCHiGAb0kn8Frx34huAsIXQ7g5qrON4v2P15jg3cNBXL4eVU67jtEjGzdIHvjMhNk3lZgalnpDDh0mszAUUFSU/55V8MFXVbes1DqjwhlrQK3MFHNpriTmnQmDU+BQ7ubLRcj65n8xm8+WJlfmeq3IcPy5aaYplKTNCq3yNVWwW5Cr7xFsKwhmJR19emQjla0emVFx4Xe/yiw3nLSLK+VaAyJyjYMurD2KfimQs1SijL7fqwjNE+USKJ/bcWSuvmCCr/g9VmFcGqQoAAA=="),e=l):"config.js"===o.r?(n.body=atob("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"),e=c):n.code=404:(n.body=atob("H4sIAAAAAAAAA6WT3W7TMBTHX8UYCbWiSdgd2mJPCCbBbuAC7Ra5zmlzWtcOPietKsTb8Ax7gb4YTtKOZWPSEDcnPh/+n5+P4/JFFSzvG6h543TZWeGMXyrwutwAG2FrEwlYtbzI3uqSkR3oL4fbSIR0+FWvD7dlMUSHDd5sQG0Rdk2ILGzwDJ6V3GHFtapgixay3pmhR0bjMrLGgTqTuqxwK6wzRIpDM7hYqb/2POaoQX/cQk1iLlL8ZHtD4MByV4qeWJehYQxebI1rQb3Rn+uVaUm8PCuLofLe5m6TDc1ev+rshbhuU3/xiQIbF8SkNKKOsFA1c0PnRbHCIZMvULCJyzS0b/M0zLW+lykLo6cPKU9nNnN64OsSfdOy6K5IRVNhGOZr+rmYeUZsOPHbGuwaEu7wPQmQFqUzc3BiEeKo/tQg69P6KzpTFsN6TJAdb7AfRvZH4tGo/wG6RuIQ909TPii4w/zYx/HZqEed/2FNmgtcPo06zt+Rvktvpl0n81zUQWdMOliyERvWqYBYfLi6UTv0VdjlLljT/ct5msgSfY7eurYCmsgu4+pALKcXDlhUKr3ydpP6zWwEw3DloPMUKF3lo9AEpjPTNOCr9zW6aqiYh2qf34t2RRG+X1OX/rE1UZAaq8gBOvWnnKJVCfsSzuVlVPI15BEaZyxMZHdwOZNy1HNC058zS48kHfp1EkyZJOCUJN47oBqAZVee94+xayQpT77s2w3LkXwKHPETZr4imd7jcca/AbWs7Y0PBQAA"),e=l);n.headers=[["Content-Type",e]],t&&n.headers.push(["Content-Encoding","gzip"])}catch(e){log("server error: "+e),n.code=500}n.send()}),Timer.set(1e4,!0,loop),loop();
//end

/**
 * Tämä käyttäjäskripti ylikirjoittaa 1. ohjauksen lähdön tarvittaessa
 * Shelly Plus Add-onin mittaaman lämpötilan perusteella.
 * 
 * Idea on, että jos lämpötila on tarpeeksi korkea, ei ohjata turhaan.
 * Ja jos lämpötila onkin liian matala, ohjataan vaikka olisi kallista.
 * 
 * Muuten mennään pörssiohjauksen mukaan.
 */
function USER_OVERRIDE(inst, cmd, callback) {
  //Otetaan tila talteen
  const state = _;
  
  //Jos kyseessä on joku muu ohjaus kuin #1 niin ei tehdä mitään
  if (inst != 0) {
    callback(cmd);
    return;
  }

  try {
    //console.log("Suoritetaan USER_OVERRIDE. Ohjauksen tila ennen: ", cmd);
    let temp = Shelly.getComponentStatus("temperature:100");

    if (!temp) {
      state.si[inst].str = "Lämpötilaohjauksen virhe - anturia 100 ei löytynyt";
      throw new Error("Lämpötila-anturia 100 ei löytynyt");
    }

    if (temp.tC == null) {
      state.si[inst].str = "Lämpötilaohjauksen virhe - onko anturi kytketty?";
      throw new Error("Onko anturi kytketty?");
    }

    if (cmd && temp.tC > 15) {
      state.si[inst].str = "Lämpötila " + temp.tC + "°C on yli 15°C -> ohjaus pois";
      console.log("Lämpötila on yli 15 astetta, asetetaan ohjaus pois. Lämpötila nyt:", temp.tC);
      cmd = false;

    } else if (!cmd && temp.tC < 5) {
      state.si[inst].str = "Lämpötila " + temp.tC + "°C on alle 5°C -> ohjaus päälle";
      console.log("Lämpötila on alle 5 astetta, asetetaan ohjaus päälle. Lämpötila nyt:", temp.tC);
      cmd = true;

    } else {
      state.si[inst].str = "Lämpötila " + temp.tC + "°C -> mennään ohjauksen mukaan";
    }
    
    //console.log("USER_OVERRIDE suoritettu. Ohjauksen tila nyt: ", cmd);
    callback(cmd);

  } catch (err) {
    console.log("Virhe tapahtui USER_OVERRIDE-funktiossa. Virhe:", err);
    state.si[inst].str = "Lämpötilaohjauksen virhe:" + err;
    callback(cmd);
  }
}