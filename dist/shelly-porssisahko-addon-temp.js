/**
 * @license
 *
 * shelly-porssisahko
 * shelly-porssisahko-en
 *
 * (c) Jussi isotalo - http://jisotalo.fi
 * https://github.com/jisotalo/shelly-porssisahko
 * https://github.com/jisotalo/shelly-porssisahko-en
 *
 * License: GNU Affero General Public License v3.0
 */
let SLOT=3600;const CNST={INST:"undefined"==typeof INSTANCE_COUNT?3:INSTANCE_COUNT,HIST:"undefined"==typeof HIST_LEN?24:HIST_LEN,ERRC:3,ERRT:120,DINS:{cTs:0,st:0,str:"",cmd:-1,cOK:0,fTs:0,fCmd:0},DCFG:{COM:{g:"fi",vat:25.5,day:0,nite:0,q:0,nms:[]},INST:{en:0,mode:0,m0:{c:0},m1:{l:0},m2:{p:24,c:0,l:-999,s:0,m:999,ps:0,pe:23,ps2:0,pe2:23,c2:0},b:0,e:0,o:[0],f:0,fc:0,i:0,m:60,oc:0}}};let _={s:{v:"4.0.0-alpha.8",dn:"",cOK:0,tOK:0,eCnt:0,eTs:0,upTs:0,tz:"+02:00",tzh:0,enC:0,p:[{ts:0,now:0,low:0,high:0,avg:0},{ts:0,now:0,low:0,high:0,avg:0}]},si:[CNST.DINS],ps:[0,0],pv:[[],[]],h:[],c:{c:CNST.DCFG.COM,i:[CNST.DCFG.INST]}},_i=0,_j=0,_k=0,_inc=0,_cnt=0,_st=0,_end=0,cmd=[],pEp=0,lRun=!1,lTmr=null;function restartLoop(e){lTmr&&(Timer.clear(lTmr),lTmr=null),lTmr=Timer.set(e,!1,loop)}function getKvsKey(e){let t="porssi";return t=0<=e?t+"-"+(e+1):t}function limit(e,t,s){return Math.min(s,Math.max(e,t))}function epoch(e){return Math.floor((e?e.getTime():Date.now())/1e3)}function getDate(e){return e.getDate()}function clearPrice(e){_.pv[e].splice(0),_.ps[e]=0,_.s.p[e].ts=0}function updateTz(e){let t=e.toString(),s=0;"+0000"==(t=t.substring(3+t.indexOf("GMT")))?(t="Z",s=0):(s=+t.substring(0,3),t=t.substring(0,3)+":"+t.substring(3)),t!=_.s.tz&&(clearPrice(0),clearPrice(1)),_.s.tz=t,_.s.tzh=s}function log(e){console.log("shelly-porssisahko: "+e)}function reqLogic(){for(let e=0;e<CNST.INST;e++)_.si[e].cTs=0}function updateState(){var e=new Date,t=(_.s.tOK=null!=Shelly.getComponentStatus("sys").unixtime&&2e3<e.getFullYear(),_.s.dn=Shelly.getComponentConfig("sys").device.name,_.s.dn||(_.s.dn=Shelly.getDeviceInfo("info"),_.s.dn&&_.s.dn.app&&_.s.dn.mac?_.s.dn=_.s.dn.app+"-"+_.s.dn.mac:_.s.dn=""),epoch(e));for(_.s.tOK&&300<Math.abs(t-pEp)&&(log("Time changed 5 min+ -> refresh"),clearPrice(_.s.p[0].now=0),clearPrice(1)),pEp=t,_.s.enC=0,_i=0;_i<CNST.INST;_i++)_.c.i[_i].en&&_.s.enC++;!_.s.upTs&&_.s.tOK&&(_.s.upTs=epoch(e))}function getConfig(a){let p=getKvsKey(a);Shelly.call("KVS.Get",{key:p},function(t,e,s){a<0?_.c.c=t?JSON.parse(t.value):{}:_.c.i[a]=t?JSON.parse(t.value):{},"function"==typeof USER_CONFIG&&USER_CONFIG(a,!0);{var n=a,o=function(e){a<0?(_.s.cOK=e?1:0,SLOT!==(1===_.c.c.q?900:3600)&&(log("Slot length set to "+(SLOT=1===_.c.c.q?900:3600)+"s ("+(900===SLOT?"15 min":"hourly")+")"),clearPrice(0),clearPrice(1))):(log("config for #"+(a+1)+" read, enabled: "+_.c.i[a].en),_.si[a].cOK=e?1:0,_.si[a].cTs=0),lRun=!1,restartLoop(500),p=null,t=null};let e=0;if(CNST.DCFG.COM||CNST.DCFG.INST){var l,i=n<0?CNST.DCFG.COM:CNST.DCFG.INST,r=n<0?_.c.c:_.c.i[n];for(l in i)if(void 0===r[l])r[l]=i[l],e++;else if("object"==typeof i[l])for(var c in i[l])void 0===r[l][c]&&(r[l][c]=i[l][c],e++);n>=CNST.INST-1&&(CNST.DCFG.COM=null,CNST.DCFG.INST=null),0<e?(n=getKvsKey(n),Shelly.call("KVS.Set",{key:n,value:JSON.stringify(r)},function(e,t,s,n){t&&log("failed to set config: "+t+" - "+s);try{n(0==t)}catch(e){log("chkConfig callback error: "+e),lRun=!1,restartLoop(1e3)}},function(e){lRun=!1,restartLoop(1e3)})):(lRun=!1,restartLoop(1e3),o(!0))}else o(!0)}})}function loop(){try{if(!lRun)if(lRun=!0,updateState(),_.s.cOK)if(pricesNeeded(0))getPrices(0);else if(pricesNeeded(1))getPrices(1);else{for(let e=0;e<CNST.INST;e++)if(!_.si[e].cOK)return void getConfig(e);for(let e=0;e<CNST.INST;e++)if(function(e){var t=_.si[e],s=_.c.i[e];if(1!=s.en)return void _.h[e].splice(0);var e=new Date,n=new Date(1e3*t.cTs);var o=Math.floor(t.cTs/SLOT),l=Math.floor(epoch(e)/SLOT);return 0==t.cTs||o!=l||n.getFullYear()!=e.getFullYear()||0<t.fTs&&t.fTs-epoch(e)<0||0==t.fTs&&s.m<60&&e.getMinutes()>=s.m&&t.cmd+s.i==1}(e))return void Timer.set(500,!1,logic,e);"function"==typeof USER_LOOP?USER_LOOP():lRun=!1}else getConfig(-1)}catch(e){log("error at main loop:"+e),lRun=!1}}function pricesNeeded(e){var t=new Date;let s=!1;return s=1==e?_.s.tOK&&0===_.s.p[1].ts&&15<=t.getHours():((e=getDate(new Date(1e3*_.s.p[0].ts))!==getDate(t))&&clearPrice(1),_.s.tOK&&(0==_.s.p[0].ts||e)),_.s.eCnt>=CNST.ERRC&&epoch(t)-_.s.eTs<CNST.ERRT?s=!1:_.s.eCnt>=CNST.ERRC&&(_.s.eCnt=0),s}function getPrices(f){try{log("fetching prices for day "+f);let o=new Date;updateTz(o);var e=1==f?new Date(864e5+new Date(o.getFullYear(),o.getMonth(),o.getDate()).getTime()):o;function t(e,t,s,n){return e.getFullYear()+"-"+(e.getMonth()<9?"0"+(1+e.getMonth()):1+e.getMonth())+"-"+(getDate(e)<10?"0"+getDate(e):getDate(e))+"T"+(t<10?"0"+t:t)+":"+(s<10?"0"+s:s)+":"+(n<10?"0"+n:n)+_.s.tz.replace("+","%2b")}let l=[{strt:t(e,0,0,0),end:t(e,11,59,59)},{strt:t(e,12,0,0),end:t(e,23,59,59)}];function d(e){log("getting prices failed, help: https://github.com/jisotalo/shelly-porssisahko/issues/59"),log(e),_.s.eCnt+=1,_.s.eTs=epoch(),clearPrice(f),0==f&&reqLogic(),lRun=!1,restartLoop(500)}_.pv[f].splice(0),_.s.p[f].avg=0,_.s.p[f].high=-999,_.s.p[f].low=999,!function e(t){var s;if(t>=l.length)return n=_.pv[f].length,_.s.p[f].avg=0<n?_.s.p[f].avg/n:0,_.s.p[f].ts=epoch(o),n<(s=86400/SLOT-Math.max(1,3600/SLOT))?(log("invalid data: got "+n+" slots, expected ≥ "+Math.floor(s)),d("insufficient slot count"),void(l=null)):(lRun=!1,restartLoop(500),l=null,void(o=null));var n={url:"https://dashboard.elering.ee/api/nps/price/csv?fields="+_.c.c.g+"&start="+l[t].strt+"&end="+l[t].end,timeout:5,ssl_ca:"*"};Shelly.call("HTTP.GET",n,function(o,l,i){try{if(0!==l||!o||200!==o.code||!o.body_b64)throw Error("HTTP error: "+l+" ("+i+") - "+JSON.stringify(o));o.headers=null,o.message=null,l=i=o.code=null,o.body_b64=atob(o.body_b64),o.body_b64=o.body_b64.substring(1+o.body_b64.indexOf("\n"));let e=0,t=0,s=-1,n=[-1,0];function r(){t<=0||(n[1]=n[1]/t,0===_.pv[f].length&&(_.ps[f]=n[0]),_.pv[f].push(n[1]),_.s.p[f].avg+=n[1],n[1]>_.s.p[f].high&&(_.s.p[f].high=n[1]),n[1]<_.s.p[f].low&&(_.s.p[f].low=n[1]),t=0,n[1]=0)}for(;0<=e;){o.body_b64=o.body_b64.substring(e);var c=[e=0,0];if(0==(e=1+o.body_b64.indexOf('"',e))){0<t&&r();break}c[0]=+o.body_b64.substring(e,o.body_b64.indexOf('"',e)),e=2+o.body_b64.indexOf('"',e),e=2+o.body_b64.indexOf(';"',e),c[1]=+(""+o.body_b64.substring(e,o.body_b64.indexOf('"',e)).replace(",",".")),c[1]=c[1]/10*(100+(0<c[1]?_.c.c.vat:0))/100;var a=new Date(1e3*c[0]).getHours(),p=(c[1]+=7<=a&&a<22?_.c.c.day:_.c.c.nite,e=o.body_b64.indexOf("\n",e),Math.floor(c[0]/SLOT)*SLOT);s<0&&(n[0]=c[0],s=p),p!==s&&(r(),n[0]=c[0],s=p),n[1]+=c[1],t++}0<t&&r(),row=o=null,order=null,n=null}catch(l){return void d("chunk "+t+" parse error: "+l)}e(t+1)})}(0)}catch(e){d("setup error: "+e)}}function logic(c){try{"function"==typeof USER_CONFIG&&USER_CONFIG(c,!1),cmd[c]=!1;let l=new Date,i=(updateTz(l),!_.s.tOK||0==_.s.p[0].ts||!_.ps[0]||0===_.pv[0].length||(n=epoch(),(o=n-_.ps[0])<0)?_.s.p[0].now=0:0<=(a=Math.floor(o/SLOT))&&a<_.pv[0].length?_.s.p[0].now=_.pv[0][a]:a===_.pv[0].length&&o-_.pv[0].length*SLOT<60?_.s.p[0].now=_.pv[0][_.pv[0].length-1]:(log("updateCurrentPrice: out-of-range idx="+a+", SLOT="+SLOT),_.s.tOK=!1,clearPrice(0),_.s.eCnt++,_.s.eTs=n),_.si[c]),r=_.c.i[c];var e,t;function s(e){if(null==e)lRun=!1;else if(cmd[c]!=e&&(i.st=12),cmd[c]=e,r.i&&(cmd[c]=!cmd[c]),log("logic for #"+(c+1)+" done, cmd: "+e+" -> output: "+cmd[c]),1==r.oc&&i.cmd==cmd[c])log("outputs already set for #"+(c+1)),i.cmd=cmd[c]?1:0,i.cTs=epoch(),lRun=!1;else{let n=0,o=0;for(let e=0;e<r.o.length;e++)!function(e,o,l){e="{id:"+o+",on:"+(cmd[e]?"true":"false")+"}",Shelly.call("Switch.Set",e,function(e,t,s,n){0!=t&&log("setting output "+o+" failed: "+t+" - "+s),l(0==t)},l)}(c,r.o[e],function(e){if(n++,e&&o++,n==r.o.length){if(o==n){if(i.cmd!=cmd[c]){for(var t=c,s=0<_.s.enC?CNST.HIST/_.s.enC:CNST.HIST;0<CNST.HIST&&_.h[t].length>=s;)_.h[t].splice(0,1);_.h[t].push([epoch(),cmd[t]?1:0,_.si[t].st])}i.cmd=cmd[c]?1:0,i.cTs=epoch(),restartLoop(500)}lRun=!1,l=null,r=null,i=null}})}}0===r.mode?(cmd[c]=1===r.m0.c,i.st=1):_.s.tOK&&0<_.s.p[0].ts&&getDate(new Date(1e3*_.s.p[0].ts))===getDate(l)?1===r.mode?(cmd[c]=_.s.p[0].now<=("avg"==r.m1.l?_.s.p[0].avg:r.m1.l),i.st=cmd[c]?2:3):2===r.mode&&(cmd[c]=function(e){var t=_.c.i[e];t.m2.ps=limit(0,t.m2.ps,23),t.m2.pe=limit(t.m2.ps,t.m2.pe,24),t.m2.ps2=limit(0,t.m2.ps2,23),t.m2.pe2=limit(t.m2.ps2,t.m2.pe2,24),t.m2.c=limit(0,t.m2.c,0<t.m2.p?t.m2.p:t.m2.pe-t.m2.ps),t.m2.c2=limit(0,t.m2.c2,t.m2.pe2-t.m2.ps2);var e=3600/SLOT,s=Math.floor(t.m2.ps*e),n=Math.floor(t.m2.pe*e),o=Math.floor(t.m2.ps2*e),l=Math.floor(t.m2.pe2*e),i=Math.floor(t.m2.c*e),r=Math.floor(t.m2.c2*e),c=t.m2.p<0?t.m2.p:Math.floor(t.m2.p*e);var a=_.pv[0];if(a&&0!==a.length&&_.ps[0]){var p=[];for(_inc=c<0?1:c,_i=0;_i<a.length;_i+=_inc)if(!((_cnt=-2==c&&1<=_i?r:i)<=0)){var f=[];for(_st=_i,_end=_i+c,c<0&&0==_i?(_st=s,_end=n):-2==c&&1==_i&&(_st=o,_end=l),_j=_st;_j<_end&&_j<a.length;_j++)f.push(_j);if(0!==f.length){if(t.m2.s){for(_avg=999,_sId=0,_j=0;_j<=f.length-_cnt;_j++){for(_sum=0,_k=_j;_k<_j+_cnt;_k++)_sum+=a[f[_k]];_sum/_cnt<_avg&&(_avg=_sum/_cnt,_sId=_j)}for(_j=_sId;_j<_sId+_cnt;_j++)p.push(f[_j])}else{for(let t=1;t<f.length;t++){var d=f[t];let e=t-1;for(;0<=e&&a[d]<a[f[e]];)f[e+1]=f[e],e--;f[e+1]=d}for(_j=0;_j<_cnt&&_j<f.length;_j++)p.push(f[_j])}if(-1==c||-2==c&&1<=_i)break}}var e=epoch(),g=Math.floor((e-_.ps[0])/SLOT);if(!(g<0||g>=a.length))for(let e=0;e<p.length;e++)if(p[e]===g)return!0}return!1}(c),i.st=cmd[c]?5:4,!cmd[c]&&_.s.p[0].now<=("avg"==r.m2.l?_.s.p[0].avg:r.m2.l)&&(cmd[c]=!0,i.st=6),cmd[c])&&_.s.p[0].now>("avg"==r.m2.m?_.s.p[0].avg:r.m2.m)&&(cmd[c]=!1,i.st=11):_.s.tOK?(i.st=7,e=1<<l.getHours(),(r.b&e)==e&&(cmd[c]=!0)):(cmd[c]=1===r.e,i.st=8),_.s.tOK&&0<r.f&&(t=1<<l.getHours(),(r.f&t)==t)&&(cmd[c]=(r.fc&t)==t,i.st=10),cmd[c]&&_.s.tOK&&l.getMinutes()>=r.m&&(i.st=13,cmd[c]=!1),_.s.tOK&&0<i.fTs&&(0<i.fTs-epoch(l)?(cmd[c]=1==i.fCmd,i.st=9):i.fTs=0),"function"==typeof USER_OVERRIDE?USER_OVERRIDE(c,cmd[c],s):s(cmd[c])}catch(e){log("error running logic: "+JSON.stringify(e)),lRun=!1}var n,o,a}let _avg=999,_sId=0,_sum=0;log("v."+_.s.v),log("URL: http://"+(Shelly.getComponentStatus("wifi").sta_ip??"192.168.33.1")+"/script/"+Shelly.getCurrentScriptId()),_.c.i.pop(),_.si.pop();for(let e=0;e<CNST.INST;e++)_.si.push(Object.assign({},CNST.DINS)),_.c.i.push(Object.assign({},CNST.DCFG.INST)),_.c.c.nms.push("-"),_.h.push([]),cmd.push(!1);CNST.DINS=null,pEp=epoch(),SLOT=1===_.c.c.q?900:3600,HTTPServer.registerEndpoint("",function(s,n){try{if(lRun)return s=null,n.code=503,void n.send();var o=function(e){var t={},s=e.split("&");for(let e=0;e<s.length;e++){var n=s[e].split("=");t[n[0]]=n[1]}return t}(s.query),l=parseInt(o.i);s=null;let e="application/json",t=(n.code=200,!0);var i,r="text/html",c="text/javascript";if("s"===o.r)updateState(),0<=l&&l<CNST.INST&&(i={s:_.s,si:_.si[l],c:_.c.c,ci:_.c.i[l],p:[{ps:_.ps[0],pv:_.pv[0]},{ps:_.ps[1],pv:_.pv[1]}],slot:SLOT},n.body=JSON.stringify(i)),t=!1;else if("c"===o.r)updateState(),0<=l&&l<CNST.INST?n.body=JSON.stringify(_.c.i[l]):n.body=JSON.stringify(_.c.c),t=!1;else if("h"===o.r)0<=l&&l<CNST.INST&&(n.body=JSON.stringify(_.h[l])),t=!1;else if("r"===o.r){if(0<=l&&l<CNST.INST)log("config changed for #"+(l+1)),_.si[l].cOK=!1;else{log("config changed");for(let e=0;e<CNST.INST;e++)_.si[e].cOK=!1}_.s.cOK=!1,reqLogic(),lRun||(lRun=!0,getConfig(l)),clearPrice(0),clearPrice(1),n.code=204,t=!1}else"f"===o.r&&o.ts?(0<=l&&l<CNST.INST&&(_.si[l].fTs=+(""+o.ts),_.si[l].fCmd=+(""+o.c),_.si[l].cTs=0),n.code=204,t=!1):o.r?"s.js"===o.r?(n.body=atob("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"),e=c):"s.css"===o.r?(n.body=atob("H4sIAAAAAAAAA41WTW/jNhD9K8QGBZJsZEvxOnVk1GhPCxTdopf2UvRAUUOLNUUKJBXbu8h/75CiZNpxsL3Y0nA+3sybGWp+f0/uiW1AymPWaWOtsLTZaeLFt+yO/NqjiAirHZWaZKRxrivn83+jZMYFKnqhRelWuKavZky3k8L8Hd+/CQbKQkk+//4n+YVzMJp8BgWGSvJHX0nBRhXyspjl5H6ORt9IpQ+ZFV+F2pb4bGowGYrW5BXf6uMDoajDtNSmJDfAeM6L8cwbU7bbGt2rGk8f2QKW+ZpIoSBrQGwbV5Ji9gnaNeFaOR8G4eWz50nCaSvksSR/gampomvS0kO2F7VrSvLp2Xi9+Fbk+Q/+2GyFQh+E9k6vSUfrOiBfdgdU6QLuGyecBESXBI0wBntM0DndBqtgwHR3PNfPZyuvT6XYqsyC5CXhEg4ZqHpNHBxcFo5KYnya3smMywP6qIXtJD0O6kHuaGXxoNNWOKG9CUjqxAusz8tX0Io9s8mkLCvg2sDD+Eq5AxPIUA4UlvbDh/UpHOpISIwnbQnUeGZdM576TKWm6EECH7A7i2GaFL7SanKXSVqBTE8rqdnugunH2Y9LX7OJkxyr/uglsa1M1EOqrJaixpSfaL5argnrjfUN1mmBuZkpbkwVI591wamUmKqWvUOkXzOhajigCvKjuxMcnyNiSXAVoa/Oas85X09dPvax7igT7hiMQ41K1gDbQf3xrCjfdzTkf8VPcPHxItUpbJFk9TiY6i5lYWsEdqP/zRy0KHOAfmTfKovW3IQh8Q/B2HYqKeTsMVThNKbD+wQ1vEeenKHKdtQgvonMMcexa6MYEY5H+0Z4YkbyaS16hLX0BFIlWjow6FEVNnQSNUQoLlQwm5IUKnRZ7LhX8vMOjtzQFiwZMvI9gX8BJA4MjrXBPengdvGU17C9Q5vXYTxmjG2c31wbZzauLrkw1mWsEbLG9q+2D1HNtugtPR13wz5Wq9ISC/8CxglG5bgKMPf3Rxq3Q9Zqz7MM84e7pBYGWFwJeh9ya6EW9DZdgitcandocXVHPXnK0m00DHTccmEMslV3SHrnO80yam5IqVwzJH+78PHn9+QL3eH8ENcAWZiaDMZkqzFxohBEIBFvlRBjOEXPZE6ycGUMtW1TBh7ITbXbvLddzmb+qv0FRzHvOPE+71NXhumb7rdh/eeJ27eMp7YF7qxKIrXDRPwPRof8LxU3tXiZgEYAEcIpovULICzQdNok7fzlPj69Lc8J8xW86UU5kMz8zCStg18G4+rlIl256D2McsAF/mbYG9oFxX2xyhPN1ei8dUV+4mOoYLycfTWKWK+w4ry6WaZFCZd5HrdlK5eXzI5RKmwfm7H2nfF8xdXR9e5vd+zgp6pHytU/lx8FhR+g19PYf7vyoRKzG8fjtCJ83KmuCw/qej1t3yJ+P7xv77n/AHPmnH4uCgAA"),e="text/css"):"status"===o.r?(n.body=atob("H4sIAAAAAAAAA5WSTW7CMBCFr2Jl1SKRkEWlLoIPUFXqolxg4hjFxD9pPIFyH87QC+RiHRxiQUt/WNiLmfe+eWO5QCi1ZEKD98vEMCESXmBHp+LPoFCyDTBXb6D3VGKqWvp5ZSfJybfLHxf8JYiY3WMUCnOEVIAANk3TiRuUjZeWealpRNR7jLNfh0PdDB+W1coiXFCt2/ELlMf9vm1VFBhXyahYKQ2xo+za8SILO/OiUttp8bV+Z3TIWs6F08lFE8WxlzPTPXxrGMwXVCynwAyHgx0OdBVZSaNITTHCG4cErVpcDXCOWjmUPfYGfoGNNnKN1DPoqLoWX/8jft07I62Fn9LnN6T/g5V/zTzevm/5bNZC07j56eNlx1qYF5zbuH30iE61yDv59uTvEoLSVwLsfbrxyT3Zx/YnFqn0K+wCAAA="),e=r):"status.js"===o.r?(n.body=atob("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"),e=c):"history"===o.r?(n.body=atob("H4sIAAAAAAAAA2WOuw7CMAxFfyXKBEOI2NNIrCwMfEFeUBejQGwQ/XtMeQipg23pnCvbLsNdJQxEnT7gQ0mZc40mVdTe/UlOL7cWyCFikdGk8k+reNR+A6cwg7t+CDea4X1B4OLstCfWPCrIHZkeiL3Q9xErH3w7pQYX9q1ct7TQEpiytY2rgfTS2Y9/AkYQ4FXSAAAA"),e=r):"history.js"===o.r?(n.body=atob("H4sIAAAAAAAAA1VS227bMAz9FZVoB2l2vHbBXurIwS4F9tBiQOM9BUHLOEysTbUyiWkRuP6b/kl/bLKDAikgEBB5dA55qNYSC6Pni7xyTWCx1KyL9l+QEEa1CQwqM01D/md5c61hwr6Y8EpUzoYtNnpcXBnRw5w3iJNPvCpi8AV0+SN6UWkM+6YSPWV/9/qYOGe/b81a8vNzs7NW68DIpDzxzjdiKVUei8C4HB0U9qA1VmweqcSlGggpRY1PaFhsiH8go/x9ez1LYOp1/cFoSEycaeDBzP1VvdqJNBqzVcSqzFKz4fpIsSMbSETUl/PxSVTLKrd615E/dgPytfOShFsLkwXnWUpOvdKFn58vRhyDOrQZDs5BGrTsT6LvBxcthlhaG4bitI1cD8ileSDZ0JOI05C8oPFHGni6wdx7lQwvA+8taYhrcP7ytKX5xWIKG0/UwCV4WkHXMx7Sv+o/uAti+/ry+mItRcBbxpkA73jjm1n5tby6m5W3c5p/XiymmaetxYokCHkWBAY2ClKAt4YSOCz82JlEh67rKuSqlqza/mM5Sxl5H+1ilR6byF2XV1Kl37/Nsu0u1LJS3X/wNQ4RlAIAAA=="),e=c):"config"===o.r?(n.body=atob("H4sIAAAAAAAAA5VW21LjNhh+FY07nYUL5yDoLpNJNOOL3UkgJJ0m0OmlIgusWJaMJYem132UPAMvkBerbNmJrRDozoDB//HT9x/kYcg2gIUj8vTsc0A4VmqkCZriEGuMRafTGXaNCRoe7YDSW05HIVMpx9uBkIJatfX2NAErz9o8SaF9xf6hg34H0gT9Nf0+WXxfgsA8Hu7Mowqu8YrT2j8BhHhGlpnfEN1jXPwZKsop0QWEZzSUqWZSgA3muUnC0CKXCWtLKUWPLJNtId+Yk+kNw45YoymjWud42LV56vQVptf+TQ8t9rso3r8JEEwfS0hMpHmJaIM1KE45ukLg1xr4grFMywTHKtfFe++bD+EAHL1CvD14kW78Z9QgMdH9HoLQ731regimqeNS8WdTPuJMa6YszgZEvU3piESUxCv5dxHoBQ27Jedu4Yq8Z6s3H98GDwvwy1ClWJTNwEyc4gV9WscmkXf73Vbv35QBWoLkeEX5WaxUIDCfdec/fgy7lWV13BkzRW8VQhx082iNc6Vx6nZPIkOK3DKX5lrjopDc0Bfu33Q7ssy1stRfH5ym1lIAWSZzEkni9GkPBUxgoHEWM4OMKuW0Yd8UkAmQ5LlpxVL9HsxcJUwYE+YgNNJDb5j/axdD9n4nNGWCtoCeYZuJVjsZLErnQpTJCv0qPqjH+502P4zjRthPapll54r5O45j6ZeRYkXt2UKqMeOqngn+m+E3TxKcbdGs7KFdN2WMS10wVSmqHjTJnqK6E1VSNrZ37PpuFfrdOaiGwFD372Jim/6n+nv+f+lIej5JwhNGPoA0nsyWwR/BbfBTgMZMmK7Da+x0TN/nLHEXyvnkt8HdYj4DY7P/Jvf3wRIsH2azyec7vAklWGOxNjtRumMJ/ZRmzsTAawSvI2dIIOpDR3aDbhzJV/TVkVwjN9IVunIkELmR/T4yK7x4KSgEF31Qgr90rGDbClorfHkYYGB3piUiQpjFeLPfcQYuYi4vB/UW1Vnd69AnduJNXNzi7Fg+Q5mqqzfo9YAP2kraUNZjtsyFZkmxE7Jq+zZdiDheZFEbDTyFA+A7gOCHiGAb0kn8Frx34huAsIXQ7g5qrON4v2P15jg3cNBXL4eVU67jtEjGzdIHvjMhNk3lZgalnpDDh0mszAUUFSU/55V8MFXVbes1DqjwhlrQK3MFHNpriTmnQmDU+BQ7ubLRcj65n8xm8+WJlfmeq3IcPy5aaYplKTNCq3yNVWwW5Cr7xFsKwhmJR19emQjla0emVFx4Xe/yiw3nLSLK+VaAyJyjYMurD2KfimQs1SijL7fqwjNE+USKJ/bcWSuvmCCr/g9VmFcGqQoAAA=="),e=r):"config.js"===o.r?(n.body=atob("H4sIAAAAAAAAA5VX647aOBR+leCtRnZJMiGt+gMwaLcXbbfTmVWZ9k9VLR7jDC65TWKmRZC36Zv0xfbYSUgCzKgVAuJzfC7+fPwdZxsKZYW0N7AjKugE5SqT8S2iVG1SkQSWmPYxQn3hZiINGRcY2fBxESHDUkHsmDI62S4S7t6tRbaZiVBwlWR/hiFGbuQ7HBE3SLLXjC8xhBBurjahcBcyB48bGmFGxt4UKXYTCidLvqEhipNYIGI/4tP/BafO4JTXws4oFjYjdDIfq8VkLON0rSy9XooytpAJsmIWweDJVhTIumfh2gxYgSbjc7CYj3gS58oKjB9bgaf3TC3dSMZY2eUj+25ikJHGNzHQsnuN612OBXGN06kRDSPckpHRPcusJWX5JuYWmG1VttnKAIvdrpcrpgQxuwUmiAe3Tgg4yDgW2d/X7y8oumALphiLXddF9RyY0QWnBGIkwlxY4LkXkq0OmlPj3+U2r5/k6IE4jzi/CRO+KvVaW8KXu7dGcs9USwYjI12wTUsKIyONpRItsR4a+R0I+VLwlViA+G6KqgHscJWW7CQrYa/6JWIibtlyV8THxnE7ZJR/1tZfjCZKFqLj+P3Vq9f/za4/wG6neF9SSapkEnfLRlfS+LzUTOak7a6cx109NPJkrfKWPHG/JlBXcOhKMxnfd9YgO0sw5cZgf0ZwOLAeCOqNxNh/PhL9PmF9Oh+H7EaE3bI3Hm6S78iSC9hBU/iQdHnA3ZQtZoplCvs28uAAjc9LF9bclMfNqoMKMzkoisYqm+gDdr2OlTQHR4+u3rzZPzuN9LJ8PAebB3JXOvfK5SOpGW2GUQB62yNFM3AG7dHATM4m5RqCZWcN6nQKZrUmbo0/5u7N2WA8FoRS/WfXdXCaD+efDbNofL/MDwisdimqraeMFKRKFsIE7TBTLeAdyWDoDWGFZjVARO3KKsuKt4uKl8chy7rn4fg4RJ7Do0VnVuS5/MTEgRPKqB124IalxndSkbU1vpvWGh6rrobXmvyuG9V38xNRfSfq2ke1/CAbv5VNc750GZUJ5UfF1CR/Yvpx7TXe/VPu/Uf8nzIQDxsAZv4BaL4d49KO2NAfvKLgTOnKIlvdqxIgaNhsqGlBHmgdoihGS0zsl3/N3HSdL/GynJmze71+tli8vhexupC5EmADLkKped40KkyqRqX7iNj3Edb0EeHe0k5LsHWdK2qaX7stEFAsTAc/6AxaoXtApWl3B626owe9QZ8ImwHH00PmNxrRsDvt8D7YaC6uwrRZmoAqoYcc7ULfk8oQtGkEcJgjgFlPlvSIsausbqj+DYBcGqKBMW+zzfaIbs7OsDaF784cfXNXUPSIamqeCQzRDCvreZXwyBn0qDK+Ah3U+LJNdP2zU9p1AcjRI46oso9qcBqeIUYcYKO2X3gGK17Na7jHTAP+oKe4pfYOxEGThlG0CAq7jtlhk0rJG2WLUCplTk8wSh0LCMPEMjxSCsJK0A6em6U1GeRNDP9ZPQkAx9X01tRW+fjP9/78Q4f+SY9+49Jv+/RPOOV+BwX/CKNqdzTHeuPS67T8G1bhnCpW47Gx8fc51bP8sgBzyr4xqaxboV7B5RPPn2w/frgozrOUn7/7NHNnQk1XAm6GaZLluXSebMsbWYHO9pckEXM4aB8/vH2ZRCncTmOF/5ldXbrl64gMNnCfJwWCqxP/vWi/FUOUMUZwKfY9rwc3QG2x25kBNwOilvAyYb02ZJq76rvqI2tnadaGZzLqJgeZzfpomtHsTFLU1+sGaEMBlI6uWRgKoF+l1j1kWHvwCGlXRp9kthRDS5NCUZQEDQTCf5GhDTsDK6cZIKDw/F+2WiVOsvzK1rmF/9hvDLEcayVylVgK7m5CxmxqYc+iFpy8tRVvVhsJ8BFAKl6HYY8yIBO4KI0xo+alEPZqmrIsF28B4yoYaoLpF5RVYlVx058/fv4AKCw8IHBrllaaSMjGI1Og1IF+0fRsmV+yS4Bht4MQp/Z/VgDIAYBcrqE4Uzk8QpVPzetYECYA4yvdi+LkGybnA/Gs/8J7yp4CUw294ozTeX+Psu89h9uX2e4punrXg9vGHndmthnqhHTvNifQX7L4ViAb+kGMhQt9HFKuTiQp/gf6X/bbeA8AAA=="),e=c):n.code=404:(n.body=atob("H4sIAAAAAAAAA6WT3W7TMBTHX8UYCbWiSdgd2mJPCCbBbuAC7Ra5zmlzWtcOPietKsTb8Ax7gb4YTtKOZWPSEDcnPh/+n5+P4/JFFSzvG6h543TZWeGMXyrwutwAG2FrEwlYtbzI3uqSkR3oL4fbSIR0+FWvD7dlMUSHDd5sQG0Rdk2ILGzwDJ6V3GHFtapgixay3pmhR0bjMrLGgTqTuqxwK6wzRIpDM7hYqb/2POaoQX/cQk1iLlL8ZHtD4MByV4qeWJehYQxebI1rQb3Rn+uVaUm8PCuLofLe5m6TDc1ev+rshbhuU3/xiQIbF8SkNKKOsFA1c0PnRbHCIZMvULCJyzS0b/M0zLW+lykLo6cPKU9nNnN64OsSfdOy6K5IRVNhGOZr+rmYeUZsOPHbGuwaEu7wPQmQFqUzc3BiEeKo/tQg69P6KzpTFsN6TJAdb7AfRvZH4tGo/wG6RuIQ909TPii4w/zYx/HZqEed/2FNmgtcPo06zt+Rvktvpl0n81zUQWdMOliyERvWqYBYfLi6UTv0VdjlLljT/ct5msgSfY7eurYCmsgu4+pALKcXDlhUKr3ydpP6zWwEw3DloPMUKF3lo9AEpjPTNOCr9zW6aqiYh2qf34t2RRG+X1OX/rE1UZAaq8gBOvWnnKJVCfsSzuVlVPI15BEaZyxMZHdwOZNy1HNC058zS48kHfp1EkyZJOCUJN47oBqAZVee94+xayQpT77s2w3LkXwKHPETZr4imd7jcca/AbWs7Y0PBQAA"),e=r);n.headers=[["Content-Type",e]],t&&n.headers.push(["Content-Encoding","gzip"])}catch(e){log("server error: "+e),n.code=500}n.send()}),Timer.set(1e4,!0,loop),loop();
//end

/**
 * Tämä käyttäjäskripti ylikirjoittaa 1. ohjauksen lähdön tarvittaessa
 * Shelly Plus Add-onin mittaaman lämpötilan perusteella.
 * 
 * Idea on, että jos lämpötila on tarpeeksi korkea, ei ohjata turhaan.
 * Ja jos lämpötila onkin liian matala, ohjataan vaikka olisi kallista.
 * 
 * Muuten mennään pörssiohjauksen mukaan.
 */
function USER_OVERRIDE(inst, cmd, callback) {
  //Otetaan tila talteen
  const state = _;
  
  //Jos kyseessä on joku muu ohjaus kuin #1 niin ei tehdä mitään
  if (inst != 0) {
    callback(cmd);
    return;
  }

  try {
    //console.log("Suoritetaan USER_OVERRIDE. Ohjauksen tila ennen: ", cmd);
    let temp = Shelly.getComponentStatus("temperature:100");

    if (!temp) {
      state.si[inst].str = "Lämpötilaohjauksen virhe - anturia 100 ei löytynyt";
      throw new Error("Lämpötila-anturia 100 ei löytynyt");
    }

    if (temp.tC == null) {
      state.si[inst].str = "Lämpötilaohjauksen virhe - onko anturi kytketty?";
      throw new Error("Onko anturi kytketty?");
    }

    if (cmd && temp.tC > 15) {
      state.si[inst].str = "Lämpötila " + temp.tC + "°C on yli 15°C -> ohjaus pois";
      console.log("Lämpötila on yli 15 astetta, asetetaan ohjaus pois. Lämpötila nyt:", temp.tC);
      cmd = false;

    } else if (!cmd && temp.tC < 5) {
      state.si[inst].str = "Lämpötila " + temp.tC + "°C on alle 5°C -> ohjaus päälle";
      console.log("Lämpötila on alle 5 astetta, asetetaan ohjaus päälle. Lämpötila nyt:", temp.tC);
      cmd = true;

    } else {
      state.si[inst].str = "Lämpötila " + temp.tC + "°C -> mennään ohjauksen mukaan";
    }
    
    //console.log("USER_OVERRIDE suoritettu. Ohjauksen tila nyt: ", cmd);
    callback(cmd);

  } catch (err) {
    console.log("Virhe tapahtui USER_OVERRIDE-funktiossa. Virhe:", err);
    state.si[inst].str = "Lämpötilaohjauksen virhe:" + err;
    callback(cmd);
  }
}